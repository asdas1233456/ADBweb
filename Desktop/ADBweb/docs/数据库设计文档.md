# 手机自动化测试平台 - 数据库设计文档

## 项目信息

- **项目名称**: 手机自动化测试平台
- **数据库类型**: SQLite
- **ORM 框架**: SQLModel / SQLAlchemy
- **后端框架**: FastAPI
- **文档版本**: v1.0
- **创建日期**: 2026-02-16

---

## 数据库概述

本数据库设计用于支持手机自动化测试平台的核心功能，包括设备管理、脚本管理、任务调度、执行监控、报告生成等。采用 SQLite 作为数据库，便于部署和维护。

---

## 实体关系图（ER Diagram）

```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│   Device    │       │   Script    │       │  Template   │
│  (设备表)   │       │  (脚本表)   │       │  (模板表)   │
└─────────────┘       └─────────────┘       └─────────────┘
       │                     │                      │
       │                     │                      │
       └──────┬──────────────┴──────────────────────┘
              │
       ┌──────▼──────┐
       │  TaskLog    │
       │ (执行日志表) │
       └──────┬──────┘
              │
       ┌──────▼──────────┐
       │ ScheduledTask   │
       │ (定时任务表)     │
       └─────────────────┘

┌─────────────┐       ┌─────────────┐
│SystemConfig │       │ActivityLog  │
│(系统配置表) │       │(活动日志表) │
└─────────────┘       └─────────────┘
```

---

## 表结构设计

### 1. Device (设备表)

存储连接到平台的 Android 设备信息。

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | - | 设备ID（主键，自增） |
| serial_number | VARCHAR(100) | UNIQUE, NOT NULL | - | 设备序列号（唯一标识） |
| model | VARCHAR(100) | NOT NULL | - | 设备型号（如 Xiaomi 12 Pro） |
| android_version | VARCHAR(20) | NOT NULL | - | Android 系统版本（如 13） |
| resolution | VARCHAR(20) | NULL | - | 屏幕分辨率（如 1440x3200） |
| battery | INTEGER | NULL | 0 | 电池电量（0-100） |
| status | VARCHAR(20) | NOT NULL | 'offline' | 设备状态（online/offline/busy） |
| last_connected_at | DATETIME | NULL | - | 最后连接时间 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- `idx_device_serial` ON `serial_number`
- `idx_device_status` ON `status`

**说明**:
- `status` 枚举值: `online`（在线）、`offline`（离线）、`busy`（使用中）
- `battery` 用于仪表盘监控设备电量
- `last_connected_at` 记录设备最后一次连接时间，用于判断设备是否长时间未连接

---

### 2. Script (脚本表)

存储用户创建的测试脚本，支持可视化、Python、批处理三种类型。

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | - | 脚本ID（主键，自增） |
| name | VARCHAR(200) | NOT NULL | - | 脚本名称 |
| type | VARCHAR(20) | NOT NULL | 'visual' | 脚本类型（visual/python/batch） |
| category | VARCHAR(50) | NOT NULL | 'other' | 脚本分类（login/test/automation/other） |
| description | TEXT | NULL | - | 脚本描述 |
| file_path | VARCHAR(500) | NULL | - | 文件路径（Python/Batch脚本） |
| file_content | TEXT | NULL | - | 文件内容（Python/Batch脚本代码） |
| steps_json | TEXT | NULL | - | 可视化脚本步骤（JSON格式） |
| is_active | BOOLEAN | NOT NULL | TRUE | 是否启用 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- `idx_script_type` ON `type`
- `idx_script_category` ON `category`
- `idx_script_name` ON `name`

**说明**:
- `type` 枚举值: `visual`（可视化）、`python`（Python脚本）、`batch`（批处理脚本）
- `category` 枚举值: `login`（登录）、`test`（测试）、`automation`（自动化）、`other`（其他）
- `steps_json` 存储可视化脚本的步骤数组，格式如: `[{"id":"s1","type":"click","name":"点击按钮","config":{"x":100,"y":200}}]`
- `file_content` 存储 Python 或 Batch 脚本的完整代码内容
- `is_active` 用于软删除，不直接删除脚本记录

---

### 3. Template (模板表)

存储脚本模板市场的预制模板。

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | - | 模板ID（主键，自增） |
| name | VARCHAR(200) | NOT NULL | - | 模板名称 |
| description | TEXT | NOT NULL | - | 模板描述 |
| author | VARCHAR(100) | NOT NULL | '系统' | 模板作者 |
| category | VARCHAR(50) | NOT NULL | 'other' | 模板分类 |
| type | VARCHAR(20) | NOT NULL | 'visual' | 模板类型（visual/python/batch） |
| tags | VARCHAR(500) | NULL | - | 标签（逗号分隔，如: 性能,启动,监控） |
| content | TEXT | NOT NULL | - | 模板内容（JSON或代码） |
| preview | TEXT | NULL | - | 预览内容 |
| downloads | INTEGER | NOT NULL | 0 | 下载次数 |
| rating | DECIMAL(3,2) | NOT NULL | 0.00 | 评分（0.00-5.00） |
| is_featured | BOOLEAN | NOT NULL | FALSE | 是否精选 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- `idx_template_category` ON `category`
- `idx_template_type` ON `type`
- `idx_template_downloads` ON `downloads` DESC
- `idx_template_rating` ON `rating` DESC

**说明**:
- `tags` 存储多个标签，用逗号分隔，便于搜索和筛选
- `downloads` 记录模板被下载的次数，用于排序和推荐
- `rating` 模板评分，范围 0.00-5.00
- `is_featured` 标记是否为精选模板，用于首页展示
- `content` 存储模板的完整内容，可以是 JSON 格式的步骤或代码文本

---

### 4. ScheduledTask (定时任务表)

存储用户创建的定时执行任务。

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | - | 任务ID（主键，自增） |
| name | VARCHAR(200) | NOT NULL | - | 任务名称 |
| script_id | INTEGER | FOREIGN KEY | - | 关联脚本ID（外键 → Script.id） |
| device_id | INTEGER | FOREIGN KEY | - | 关联设备ID（外键 → Device.id） |
| frequency | VARCHAR(50) | NOT NULL | - | 执行频率（daily/weekly/monthly） |
| schedule_time | TIME | NOT NULL | - | 执行时间（HH:MM:SS） |
| schedule_day | VARCHAR(20) | NULL | - | 执行日期（周几或几号） |
| is_enabled | BOOLEAN | NOT NULL | TRUE | 是否启用 |
| last_run_at | DATETIME | NULL | - | 上次运行时间 |
| next_run_at | DATETIME | NULL | - | 下次运行时间 |
| run_count | INTEGER | NOT NULL | 0 | 累计运行次数 |
| success_count | INTEGER | NOT NULL | 0 | 成功次数 |
| fail_count | INTEGER | NOT NULL | 0 | 失败次数 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- `idx_scheduled_task_script` ON `script_id`
- `idx_scheduled_task_device` ON `device_id`
- `idx_scheduled_task_enabled` ON `is_enabled`
- `idx_scheduled_task_next_run` ON `next_run_at`

**外键约束**:
- `FOREIGN KEY (script_id) REFERENCES Script(id) ON DELETE CASCADE`
- `FOREIGN KEY (device_id) REFERENCES Device(id) ON DELETE CASCADE`

**说明**:
- `frequency` 枚举值: `daily`（每天）、`weekly`（每周）、`monthly`（每月）
- `schedule_day` 当 frequency 为 weekly 时，存储星期几（如 Monday）；为 monthly 时，存储几号（如 15）
- `next_run_at` 由系统自动计算，用于任务调度器判断是否需要执行
- `run_count`、`success_count`、`fail_count` 用于统计任务执行情况

---

### 5. TaskLog (任务执行日志表)

记录脚本执行的详细日志和结果。

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | - | 日志ID（主键，自增） |
| task_name | VARCHAR(200) | NOT NULL | - | 任务名称 |
| script_id | INTEGER | FOREIGN KEY | - | 关联脚本ID（外键 → Script.id） |
| device_id | INTEGER | FOREIGN KEY | - | 关联设备ID（外键 → Device.id） |
| scheduled_task_id | INTEGER | FOREIGN KEY, NULL | - | 关联定时任务ID（外键 → ScheduledTask.id） |
| status | VARCHAR(20) | NOT NULL | 'running' | 执行状态（running/success/failed） |
| start_time | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 开始时间 |
| end_time | DATETIME | NULL | - | 结束时间 |
| duration | DECIMAL(10,2) | NULL | - | 执行耗时（秒） |
| log_content | TEXT | NULL | - | 日志内容（完整日志） |
| error_message | TEXT | NULL | - | 错误信息 |
| screenshot_paths | TEXT | NULL | - | 截图路径（JSON数组） |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- `idx_task_log_script` ON `script_id`
- `idx_task_log_device` ON `device_id`
- `idx_task_log_status` ON `status`
- `idx_task_log_start_time` ON `start_time` DESC

**外键约束**:
- `FOREIGN KEY (script_id) REFERENCES Script(id) ON DELETE SET NULL`
- `FOREIGN KEY (device_id) REFERENCES Device(id) ON DELETE SET NULL`
- `FOREIGN KEY (scheduled_task_id) REFERENCES ScheduledTask(id) ON DELETE SET NULL`

**说明**:
- `status` 枚举值: `running`（运行中）、`success`（成功）、`failed`（失败）
- `duration` 自动计算: `end_time - start_time`
- `log_content` 存储完整的执行日志，包含每个步骤的详细信息
- `screenshot_paths` 存储截图文件路径的 JSON 数组，格式如: `["screenshots/001.png","screenshots/002.png"]`
- `scheduled_task_id` 如果是定时任务触发的执行，则记录定时任务ID

---

### 6. SystemConfig (系统配置表)

存储系统级别的配置项，采用键值对形式。

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | - | 配置ID（主键，自增） |
| config_key | VARCHAR(100) | UNIQUE, NOT NULL | - | 配置键（唯一） |
| config_value | TEXT | NULL | - | 配置值 |
| config_type | VARCHAR(20) | NOT NULL | 'string' | 配置类型（string/number/boolean/json） |
| description | VARCHAR(500) | NULL | - | 配置说明 |
| is_system | BOOLEAN | NOT NULL | FALSE | 是否系统配置（不可删除） |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- `idx_system_config_key` ON `config_key` UNIQUE

**说明**:
- `config_key` 配置键示例: `adb_path`、`python_path`、`screenshot_quality`、`log_level` 等
- `config_type` 用于前端正确解析配置值类型
- `is_system` 标记为系统配置的项不允许用户删除，只能修改值

**预设配置项**:
```
adb_path: C:\platform-tools\adb.exe
python_path: C:\Python39\python.exe
auto_connect: true
auto_refresh: true
refresh_interval: 5
log_level: info
max_log_lines: 1000
screenshot_quality: high
screenshot_format: png
enable_notification: true
enable_sound: false
```

---

### 7. ActivityLog (活动日志表)

记录用户在平台上的操作活动，用于仪表盘"最近活动"展示。

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | - | 活动ID（主键，自增） |
| activity_type | VARCHAR(50) | NOT NULL | - | 活动类型（script_execute/device_connect等） |
| description | TEXT | NOT NULL | - | 活动描述 |
| user_name | VARCHAR(100) | NULL | '系统' | 操作人 |
| related_id | INTEGER | NULL | - | 关联对象ID（如脚本ID、设备ID） |
| related_type | VARCHAR(50) | NULL | - | 关联对象类型（script/device/task） |
| status | VARCHAR(20) | NOT NULL | 'success' | 活动状态（success/failed） |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- `idx_activity_log_type` ON `activity_type`
- `idx_activity_log_created` ON `created_at` DESC

**说明**:
- `activity_type` 活动类型示例:
  - `script_execute`: 脚本执行
  - `device_connect`: 设备连接
  - `device_disconnect`: 设备断开
  - `script_create`: 创建脚本
  - `script_update`: 更新脚本
  - `script_delete`: 删除脚本
  - `scheduled_task_create`: 创建定时任务
  - `template_download`: 下载模板
- `description` 存储用户可读的活动描述，如: "登录测试脚本在 Xiaomi 12 Pro 上执行成功"
- `related_id` 和 `related_type` 用于关联具体的对象，便于跳转查看详情

---

## SQLModel 模型定义示例

### Device 模型

```python
from sqlmodel import SQLModel, Field
from datetime import datetime
from typing import Optional

class Device(SQLModel, table=True):
    """设备表模型"""
    __tablename__ = "device"
    
    id: Optional[int] = Field(default=None, primary_key=True, description="设备ID")
    serial_number: str = Field(unique=True, index=True, max_length=100, description="设备序列号")
    model: str = Field(max_length=100, description="设备型号")
    android_version: str = Field(max_length=20, description="Android版本")
    resolution: Optional[str] = Field(default=None, max_length=20, description="屏幕分辨率")
    battery: int = Field(default=0, ge=0, le=100, description="电池电量")
    status: str = Field(default="offline", max_length=20, description="设备状态")
    last_connected_at: Optional[datetime] = Field(default=None, description="最后连接时间")
    created_at: datetime = Field(default_factory=datetime.now, description="创建时间")
    updated_at: datetime = Field(default_factory=datetime.now, description="更新时间")
```

### Script 模型

```python
class Script(SQLModel, table=True):
    """脚本表模型"""
    __tablename__ = "script"
    
    id: Optional[int] = Field(default=None, primary_key=True, description="脚本ID")
    name: str = Field(max_length=200, description="脚本名称")
    type: str = Field(default="visual", max_length=20, description="脚本类型")
    category: str = Field(default="other", max_length=50, description="脚本分类")
    description: Optional[str] = Field(default=None, description="脚本描述")
    file_path: Optional[str] = Field(default=None, max_length=500, description="文件路径")
    file_content: Optional[str] = Field(default=None, description="文件内容")
    steps_json: Optional[str] = Field(default=None, description="可视化步骤JSON")
    is_active: bool = Field(default=True, description="是否启用")
    created_at: datetime = Field(default_factory=datetime.now, description="创建时间")
    updated_at: datetime = Field(default_factory=datetime.now, description="更新时间")
```

---

## 数据库初始化脚本

### 创建表 SQL

```sql
-- 1. 设备表
CREATE TABLE IF NOT EXISTS device (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    serial_number VARCHAR(100) UNIQUE NOT NULL,
    model VARCHAR(100) NOT NULL,
    android_version VARCHAR(20) NOT NULL,
    resolution VARCHAR(20),
    battery INTEGER DEFAULT 0,
    status VARCHAR(20) DEFAULT 'offline' NOT NULL,
    last_connected_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL
);

CREATE INDEX idx_device_serial ON device(serial_number);
CREATE INDEX idx_device_status ON device(status);

-- 2. 脚本表
CREATE TABLE IF NOT EXISTS script (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(200) NOT NULL,
    type VARCHAR(20) DEFAULT 'visual' NOT NULL,
    category VARCHAR(50) DEFAULT 'other' NOT NULL,
    description TEXT,
    file_path VARCHAR(500),
    file_content TEXT,
    steps_json TEXT,
    is_active BOOLEAN DEFAULT TRUE NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL
);

CREATE INDEX idx_script_type ON script(type);
CREATE INDEX idx_script_category ON script(category);
CREATE INDEX idx_script_name ON script(name);

-- 3. 模板表
CREATE TABLE IF NOT EXISTS template (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(200) NOT NULL,
    description TEXT NOT NULL,
    author VARCHAR(100) DEFAULT '系统' NOT NULL,
    category VARCHAR(50) DEFAULT 'other' NOT NULL,
    type VARCHAR(20) DEFAULT 'visual' NOT NULL,
    tags VARCHAR(500),
    content TEXT NOT NULL,
    preview TEXT,
    downloads INTEGER DEFAULT 0 NOT NULL,
    rating DECIMAL(3,2) DEFAULT 0.00 NOT NULL,
    is_featured BOOLEAN DEFAULT FALSE NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL
);

CREATE INDEX idx_template_category ON template(category);
CREATE INDEX idx_template_type ON template(type);
CREATE INDEX idx_template_downloads ON template(downloads DESC);
CREATE INDEX idx_template_rating ON template(rating DESC);

-- 4. 定时任务表
CREATE TABLE IF NOT EXISTS scheduled_task (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(200) NOT NULL,
    script_id INTEGER NOT NULL,
    device_id INTEGER NOT NULL,
    frequency VARCHAR(50) NOT NULL,
    schedule_time TIME NOT NULL,
    schedule_day VARCHAR(20),
    is_enabled BOOLEAN DEFAULT TRUE NOT NULL,
    last_run_at DATETIME,
    next_run_at DATETIME,
    run_count INTEGER DEFAULT 0 NOT NULL,
    success_count INTEGER DEFAULT 0 NOT NULL,
    fail_count INTEGER DEFAULT 0 NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL,
    FOREIGN KEY (script_id) REFERENCES script(id) ON DELETE CASCADE,
    FOREIGN KEY (device_id) REFERENCES device(id) ON DELETE CASCADE
);

CREATE INDEX idx_scheduled_task_script ON scheduled_task(script_id);
CREATE INDEX idx_scheduled_task_device ON scheduled_task(device_id);
CREATE INDEX idx_scheduled_task_enabled ON scheduled_task(is_enabled);
CREATE INDEX idx_scheduled_task_next_run ON scheduled_task(next_run_at);

-- 5. 任务执行日志表
CREATE TABLE IF NOT EXISTS task_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_name VARCHAR(200) NOT NULL,
    script_id INTEGER,
    device_id INTEGER,
    scheduled_task_id INTEGER,
    status VARCHAR(20) DEFAULT 'running' NOT NULL,
    start_time DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL,
    end_time DATETIME,
    duration DECIMAL(10,2),
    log_content TEXT,
    error_message TEXT,
    screenshot_paths TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL,
    FOREIGN KEY (script_id) REFERENCES script(id) ON DELETE SET NULL,
    FOREIGN KEY (device_id) REFERENCES device(id) ON DELETE SET NULL,
    FOREIGN KEY (scheduled_task_id) REFERENCES scheduled_task(id) ON DELETE SET NULL
);

CREATE INDEX idx_task_log_script ON task_log(script_id);
CREATE INDEX idx_task_log_device ON task_log(device_id);
CREATE INDEX idx_task_log_status ON task_log(status);
CREATE INDEX idx_task_log_start_time ON task_log(start_time DESC);

-- 6. 系统配置表
CREATE TABLE IF NOT EXISTS system_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value TEXT,
    config_type VARCHAR(20) DEFAULT 'string' NOT NULL,
    description VARCHAR(500),
    is_system BOOLEAN DEFAULT FALSE NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL
);

CREATE UNIQUE INDEX idx_system_config_key ON system_config(config_key);

-- 7. 活动日志表
CREATE TABLE IF NOT EXISTS activity_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    activity_type VARCHAR(50) NOT NULL,
    description TEXT NOT NULL,
    user_name VARCHAR(100) DEFAULT '系统',
    related_id INTEGER,
    related_type VARCHAR(50),
    status VARCHAR(20) DEFAULT 'success' NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL
);

CREATE INDEX idx_activity_log_type ON activity_log(activity_type);
CREATE INDEX idx_activity_log_created ON activity_log(created_at DESC);
```

---

## 初始化数据

### 系统配置初始数据

```sql
INSERT INTO system_config (config_key, config_value, config_type, description, is_system) VALUES
('adb_path', 'C:\platform-tools\adb.exe', 'string', 'ADB工具路径', TRUE),
('python_path', 'C:\Python39\python.exe', 'string', 'Python解释器路径', TRUE),
('auto_connect', 'true', 'boolean', '自动连接设备', TRUE),
('auto_refresh', 'true', 'boolean', '自动刷新设备列表', TRUE),
('refresh_interval', '5', 'number', '刷新间隔（秒）', TRUE),
('log_level', 'info', 'string', '日志级别', TRUE),
('max_log_lines', '1000', 'number', '最大日志行数', TRUE),
('screenshot_quality', 'high', 'string', '截图质量', TRUE),
('screenshot_format', 'png', 'string', '截图格式', TRUE),
('enable_notification', 'true', 'boolean', '启用桌面通知', TRUE),
('enable_sound', 'false', 'boolean', '启用提示音', TRUE);
```

### 模板初始数据

```sql
INSERT INTO template (name, description, author, category, type, tags, content, preview, downloads, rating, is_featured) VALUES
('APP启动性能测试', '自动测试APP启动时间、内存占用、CPU使用率等性能指标', '测试专家', '性能测试', 'python', '性能,启动,监控', 'import time\nimport subprocess\n\ndef test_app_launch():\n    pass', 'import time\nimport subprocess', 1250, 4.8, TRUE),
('自动登录模板', '通用的登录流程自动化脚本，支持账号密码、验证码识别', '自动化大师', '功能测试', 'visual', '登录,自动化,通用', '{"steps":[]}', '可视化步骤：点击 → 输入 → 等待 → 验证', 2100, 4.9, TRUE),
('批量截图工具', '自动遍历APP所有页面并截图保存，用于UI测试和文档制作', 'UI测试员', 'UI测试', 'python', '截图,UI,批量', 'def capture_screens():\n    pass', 'def capture_screens():', 890, 4.6, FALSE);
```

---

## 数据库维护

### 备份策略

1. **自动备份**: 每天凌晨 2:00 自动备份数据库文件
2. **手动备份**: 在系统设置中提供手动备份功能
3. **备份保留**: 保留最近 30 天的备份文件

### 清理策略

1. **日志清理**: 自动清理 90 天前的 `task_log` 和 `activity_log` 记录
2. **软删除**: 脚本、设备等核心数据使用软删除（`is_active` 字段）
3. **定期优化**: 每周执行一次 `VACUUM` 命令优化数据库

---

## 性能优化建议

1. **索引优化**: 为常用查询字段创建索引
2. **分页查询**: 大数据量列表使用分页查询
3. **连接池**: 使用数据库连接池提高并发性能
4. **缓存策略**: 对系统配置等热点数据使用缓存
5. **异步操作**: 日志写入等操作使用异步处理

---

## 数据迁移

如需从 SQLite 迁移到 PostgreSQL 或 MySQL，可使用以下工具：
- SQLAlchemy 的 `alembic` 进行数据库迁移
- 使用 `pgloader` 工具进行数据导入

---

## 附录

### 枚举值定义

```python
# 设备状态
class DeviceStatus:
    ONLINE = "online"      # 在线
    OFFLINE = "offline"    # 离线
    BUSY = "busy"          # 使用中

# 脚本类型
class ScriptType:
    VISUAL = "visual"      # 可视化
    PYTHON = "python"      # Python脚本
    BATCH = "batch"        # 批处理脚本

# 脚本分类
class ScriptCategory:
    LOGIN = "login"        # 登录
    TEST = "test"          # 测试
    AUTOMATION = "automation"  # 自动化
    OTHER = "other"        # 其他

# 任务状态
class TaskStatus:
    RUNNING = "running"    # 运行中
    SUCCESS = "success"    # 成功
    FAILED = "failed"      # 失败

# 定时任务频率
class TaskFrequency:
    DAILY = "daily"        # 每天
    WEEKLY = "weekly"      # 每周
    MONTHLY = "monthly"    # 每月
```

---

**文档版本**: v1.0  
**最后更新**: 2026-02-16  
**维护人员**: 开发团队
