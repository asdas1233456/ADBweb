# ADBweb é¡¹ç›®æŠ€æœ¯æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **é¡¹ç›®åç§°**: ADBweb - Android è‡ªåŠ¨åŒ–æµ‹è¯•å¹³å°
- **æŠ€æœ¯æ ˆ**: FastAPI + SQLModel + React + TypeScript + WebSocket + AI
- **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
- **åˆ›å»ºæ—¥æœŸ**: 2026-02-24
- **æ›´æ–°æ—¥æœŸ**: 2026-02-26
- **æ–‡æ¡£ç”¨é€”**: æŠ€æœ¯å¤ç›˜ã€ä»£ç å®¡æŸ¥ã€æ¶æ„è®¾è®¡å‚è€ƒ

---

## ç›®å½•

1. [ç³»ç»Ÿæ¶æ„è®¾è®¡](#ç³»ç»Ÿæ¶æ„è®¾è®¡)
2. [æ ¸å¿ƒåŠŸèƒ½å®ç°](#æ ¸å¿ƒåŠŸèƒ½å®ç°)
3. [AI åŠŸèƒ½æ¶æ„](#ai-åŠŸèƒ½æ¶æ„)
4. [å…³é”®ç®—æ³•è¯¦è§£](#å…³é”®ç®—æ³•è¯¦è§£)
5. [æ•°æ®æ¨¡å‹è®¾è®¡](#æ•°æ®æ¨¡å‹è®¾è®¡)
6. [API è®¾è®¡åŸç†](#api-è®¾è®¡åŸç†)
7. [WebSocket å®æ—¶é€šä¿¡](#websocket-å®æ—¶é€šä¿¡)
8. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
9. [æµ‹è¯•ç­–ç•¥](#æµ‹è¯•ç­–ç•¥)

---

## ç³»ç»Ÿæ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å±‚ (React)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ä»ªè¡¨ç›˜   â”‚  â”‚ è®¾å¤‡ç®¡ç† â”‚  â”‚ è„šæœ¬ç®¡ç† â”‚  â”‚ AIè„šæœ¬ç”Ÿæˆâ”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å¥åº·ç›‘æ§ â”‚  â”‚ ä»»åŠ¡æ‰§è¡Œ â”‚  â”‚ è„šæœ¬æ¨¡æ¿ â”‚  â”‚ æŠ¥å‘Šä¸­å¿ƒ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚              â”‚              â”‚              â”‚       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                          â”‚                                    â”‚
â”‚                    HTTP/WebSocket                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API ç½‘å…³å±‚ (FastAPI)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ REST API â”‚  â”‚ WebSocketâ”‚  â”‚ æ–‡ä»¶ä¸Šä¼  â”‚  â”‚ å¼‚å¸¸å¤„ç† â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸šåŠ¡é€»è¾‘å±‚ (Services)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ è®¾å¤‡å¥åº·ç›‘æ§ â”‚  â”‚ å¤±è´¥åˆ†æå¼•æ“ â”‚  â”‚ ä»»åŠ¡æ‰§è¡Œå™¨   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ AIè„šæœ¬ç”Ÿæˆå™¨ â”‚  â”‚ æ‰¹é‡ç”Ÿæˆå™¨   â”‚  â”‚ æ¨¡æ¿æœåŠ¡     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ å‘Šè­¦å¼•æ“     â”‚  â”‚ è°ƒåº¦æœåŠ¡     â”‚  â”‚ WebSocketç®¡ç†â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®è®¿é—®å±‚ (SQLModel)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Device   â”‚  â”‚ Script   â”‚  â”‚ TaskLog  â”‚  â”‚ Health   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚AIScript  â”‚  â”‚ Template â”‚  â”‚TestCase  â”‚  â”‚ Alert    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®å­˜å‚¨å±‚ (SQLite)                        â”‚
â”‚                    test_platform.db                          â”‚
â”‚                    (20+ æ•°æ®è¡¨)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¤–éƒ¨æœåŠ¡é›†æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å¤–éƒ¨AIæœåŠ¡ (External)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  OpenAI API â”‚ â”‚ DeepSeek APIâ”‚ â”‚  å…¶ä»–AIæœåŠ¡  â”‚           â”‚
â”‚  â”‚  (GPTæ¨¡å‹)   â”‚ â”‚  (å›½äº§AI)   â”‚ â”‚  (æ‰©å±•æ”¯æŒ)  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                         HTTP API è°ƒç”¨
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   AIæœåŠ¡ä»£ç†å±‚   â”‚
                    â”‚  (ç»Ÿä¸€æ¥å£ç®¡ç†)  â”‚
                    â”‚  (è§„åˆ™å¼•æ“å¤‡é€‰)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯é€‰å‹ç†ç”±


**åç«¯æ¡†æ¶ - FastAPI**
- é«˜æ€§èƒ½å¼‚æ­¥æ¡†æ¶ï¼Œæ”¯æŒ WebSocket
- è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£ (Swagger/OpenAPI)
- ç±»å‹æç¤ºå’Œæ•°æ®éªŒè¯ (Pydantic)
- æ˜“äºæµ‹è¯•å’Œç»´æŠ¤

**ORM æ¡†æ¶ - SQLModel**
- ç»“åˆ SQLAlchemy å’Œ Pydantic çš„ä¼˜åŠ¿
- ç±»å‹å®‰å…¨çš„æ•°æ®åº“æ“ä½œ
- è‡ªåŠ¨ç”Ÿæˆæ•°æ®åº“è¡¨ç»“æ„
- æ”¯æŒå¼‚æ­¥æ“ä½œ

**å‰ç«¯æ¡†æ¶ - React + TypeScript**
- ç»„ä»¶åŒ–å¼€å‘ï¼Œä»£ç å¤ç”¨æ€§é«˜
- TypeScript æä¾›ç±»å‹å®‰å…¨
- ä¸°å¯Œçš„ç”Ÿæ€ç³»ç»Ÿå’Œç¤¾åŒºæ”¯æŒ
- Ant Design æä¾›å®Œæ•´çš„ UI ç»„ä»¶

**å®æ—¶é€šä¿¡ - WebSocket**
- åŒå‘é€šä¿¡ï¼Œå®æ—¶æ¨é€æ•°æ®
- ä½å»¶è¿Ÿï¼Œé€‚åˆä»»åŠ¡ç›‘æ§åœºæ™¯
- æ”¯æŒå¤šå®¢æˆ·ç«¯è¿æ¥ç®¡ç†
- è‡ªåŠ¨é‡è¿æœºåˆ¶

**æ•°æ®åº“ - SQLite**
- è½»é‡çº§ï¼Œæ— éœ€ç‹¬ç«‹æœåŠ¡å™¨
- æ˜“äºéƒ¨ç½²å’Œå¤‡ä»½
- é€‚åˆä¸­å°è§„æ¨¡åº”ç”¨
- æ”¯æŒå®Œæ•´çš„ SQL åŠŸèƒ½

---

## æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. è®¾å¤‡å¥åº·åº¦ç›‘æ§ç³»ç»Ÿ

#### 1.1 å¥åº·åº¦è¯„åˆ†ç®—æ³•

**æ ¸å¿ƒä»£ç **: `backend/app/services/device_health.py`

```python
def calculate_health_score(self, metrics: Dict) -> int:
    """
    è®¡ç®—è®¾å¤‡å¥åº·åº¦åˆ†æ•° (0-100)
    
    è¯„åˆ†ç»´åº¦å’Œæƒé‡:
    - ç”µé‡ (25%): ç”µé‡è¶Šé«˜åˆ†æ•°è¶Šé«˜
    - æ¸©åº¦ (20%): æ¸©åº¦è¶Šä½åˆ†æ•°è¶Šé«˜
    - CPUä½¿ç”¨ç‡ (15%): ä½¿ç”¨ç‡è¶Šä½åˆ†æ•°è¶Šé«˜
    - å†…å­˜ä½¿ç”¨ç‡ (15%): ä½¿ç”¨ç‡è¶Šä½åˆ†æ•°è¶Šé«˜
    - å­˜å‚¨ä½¿ç”¨ç‡ (10%): ä½¿ç”¨ç‡è¶Šä½åˆ†æ•°è¶Šé«˜
    - ç½‘ç»œçŠ¶æ€ (10%): è¿æ¥æ­£å¸¸å¾—æ»¡åˆ†
    - æ´»è·ƒåº¦ (5%): æœ€è¿‘æ´»è·ƒå¾—æ»¡åˆ†
    """
    score = 0
    
    # 1. ç”µé‡è¯„åˆ† (25åˆ†)
    battery = metrics.get('battery_level', 0)
    if battery >= 80:
        score += 25
    elif battery >= 50:
        score += 20
    elif battery >= 20:
        score += 15
    else:
        score += 5
    
    # 2. æ¸©åº¦è¯„åˆ† (20åˆ†)
    temp = metrics.get('temperature', 30)
    if temp <= 35:
        score += 20
    elif temp <= 40:
        score += 15
    elif temp <= 45:
        score += 10
    else:
        score += 5
    
    # 3. CPUä½¿ç”¨ç‡è¯„åˆ† (15åˆ†)
    cpu = metrics.get('cpu_usage', 0)
    if cpu <= 30:
        score += 15
    elif cpu <= 50:
        score += 12
    elif cpu <= 70:
        score += 8
    else:
        score += 4
    
    # 4. å†…å­˜ä½¿ç”¨ç‡è¯„åˆ† (15åˆ†)
    memory = metrics.get('memory_usage', 0)
    if memory <= 50:
        score += 15
    elif memory <= 70:
        score += 12
    elif memory <= 85:
        score += 8
    else:
        score += 4
    
    # 5. å­˜å‚¨ä½¿ç”¨ç‡è¯„åˆ† (10åˆ†)
    storage = metrics.get('storage_usage', 0)
    if storage <= 70:
        score += 10
    elif storage <= 85:
        score += 7
    elif storage <= 95:
        score += 4
    else:
        score += 2
    
    # 6. ç½‘ç»œçŠ¶æ€è¯„åˆ† (10åˆ†)
    network = metrics.get('network_status', 'disconnected')
    if network == 'connected':
        score += 10
    elif network == 'limited':
        score += 5
    
    # 7. æ´»è·ƒåº¦è¯„åˆ† (5åˆ†)
    last_active = metrics.get('last_active_time')
    if last_active:
        time_diff = (datetime.now() - last_active).total_seconds()
        if time_diff < 300:  # 5åˆ†é’Ÿå†…æ´»è·ƒ
            score += 5
        elif time_diff < 3600:  # 1å°æ—¶å†…æ´»è·ƒ
            score += 3
    
    return min(score, 100)
```

**ç®—æ³•ç‰¹ç‚¹**:
- å¤šç»´åº¦åŠ æƒè¯„åˆ†ï¼Œå…¨é¢è¯„ä¼°è®¾å¤‡çŠ¶æ€
- åˆ†æ®µè¯„åˆ†ï¼ŒåŒºåˆ†ä¸åŒå¥åº·ç­‰çº§
- åŠ¨æ€æƒé‡ï¼Œå¯æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´
- ä¸Šé™ä¿æŠ¤ï¼Œç¡®ä¿åˆ†æ•°åœ¨ 0-100 èŒƒå›´å†…


#### 1.2 å¥åº·ç­‰çº§åˆ†ç±»

```python
def get_health_level(self, score: int) -> tuple:
    """
    æ ¹æ®å¥åº·åº¦åˆ†æ•°è¿”å›ç­‰çº§ä¿¡æ¯
    
    Returns:
        (level_code, level_name, level_color)
    """
    if score >= 90:
        return ('excellent', 'ä¼˜ç§€', '#52c41a')
    elif score >= 75:
        return ('good', 'è‰¯å¥½', '#1890ff')
    elif score >= 60:
        return ('fair', 'ä¸€èˆ¬', '#faad14')
    elif score >= 40:
        return ('poor', 'è¾ƒå·®', '#ff7a45')
    else:
        return ('critical', 'å±é™©', '#f5222d')
```

**ç­‰çº§åˆ’åˆ†ä¾æ®**:
- ä¼˜ç§€ (90-100): è®¾å¤‡çŠ¶æ€æä½³ï¼Œå¯æ‰¿æ‹…é«˜è´Ÿè½½ä»»åŠ¡
- è‰¯å¥½ (75-89): è®¾å¤‡çŠ¶æ€æ­£å¸¸ï¼Œé€‚åˆå¸¸è§„ä»»åŠ¡
- ä¸€èˆ¬ (60-74): éœ€è¦å…³æ³¨ï¼Œå»ºè®®é™ä½ä»»åŠ¡é¢‘ç‡
- è¾ƒå·® (40-59): éœ€è¦ç»´æŠ¤ï¼Œé¿å…æ‰§è¡Œé‡è¦ä»»åŠ¡
- å±é™© (<40): ç«‹å³å¤„ç†ï¼Œåœæ­¢ä»»åŠ¡æ‰§è¡Œ

#### 1.3 å®šæ—¶é‡‡é›†è°ƒåº¦å™¨

**æ ¸å¿ƒä»£ç **: `backend/app/services/health_scheduler.py`

```python
class HealthScheduler:
    """å¥åº·åº¦è°ƒåº¦å™¨ - å®šæ—¶é‡‡é›†è®¾å¤‡å¥åº·æ•°æ®"""
    
    def __init__(self):
        self.scheduler = AsyncIOScheduler()
        self.health_service = DeviceHealthService()
    
    async def collect_device_health(self):
        """å®šæ—¶é‡‡é›†è®¾å¤‡å¥åº·æ•°æ®"""
        with Session(engine) as session:
            # è·å–æ‰€æœ‰åœ¨çº¿è®¾å¤‡
            statement = select(Device).where(Device.status == 'online')
            devices = session.exec(statement).all()
            
            alert_engine = AlertEngine(session)
            
            for device in devices:
                # é‡‡é›†è®¾å¤‡æŒ‡æ ‡
                metrics = self.health_service.generate_mock_metrics(device.id)
                
                # è®¡ç®—å¥åº·åº¦åˆ†æ•°
                health_score = self.health_service.calculate_health_score(metrics)
                
                # æ›´æ–°è®¾å¤‡ä¿¡æ¯
                device.battery = metrics.get('battery_level')
                device.cpu_usage = metrics.get('cpu_usage')
                device.memory_usage = metrics.get('memory_usage')
                session.add(device)
                
                # ä¿å­˜å¥åº·åº¦è®°å½•
                health_record = DeviceHealthRecord(
                    device_id=device.id,
                    health_score=health_score,
                    battery_level=metrics.get('battery_level'),
                    temperature=metrics.get('temperature'),
                    cpu_usage=metrics.get('cpu_usage'),
                    memory_usage=metrics.get('memory_usage'),
                    storage_usage=metrics.get('storage_usage'),
                    network_status=metrics.get('network_status'),
                    last_active_time=metrics.get('last_active_time')
                )
                session.add(health_record)
                
                # æ£€æŸ¥å‘Šè­¦
                alerts = await alert_engine.check_alerts(device.id, metrics)
                
                session.commit()
    
    def start(self):
        """å¯åŠ¨è°ƒåº¦å™¨ - æ¯5åˆ†é’Ÿé‡‡é›†ä¸€æ¬¡"""
        self.scheduler.add_job(
            self.collect_device_health,
            'interval',
            minutes=5,
            id='collect_device_health',
            replace_existing=True
        )
        self.scheduler.start()
```

**è®¾è®¡è¦ç‚¹**:
- ä½¿ç”¨ APScheduler å®ç°å®šæ—¶ä»»åŠ¡
- å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
- æ‰¹é‡å¤„ç†åœ¨çº¿è®¾å¤‡ï¼Œæé«˜æ•ˆç‡
- è‡ªåŠ¨ä¿å­˜å†å²è®°å½•ï¼Œæ”¯æŒè¶‹åŠ¿åˆ†æ
- é›†æˆå‘Šè­¦å¼•æ“ï¼Œå®æ—¶ç›‘æ§å¼‚å¸¸

---

### 2. å‘Šè­¦è§„åˆ™å¼•æ“

#### 2.1 å‘Šè­¦è§„åˆ™è¯„ä¼°

**æ ¸å¿ƒä»£ç **: `backend/app/services/alert_engine.py`

```python
class AlertEngine:
    """å‘Šè­¦å¼•æ“ - æ£€æŸ¥è®¾å¤‡æŒ‡æ ‡å¹¶è§¦å‘å‘Šè­¦"""
    
    def _evaluate_rule(self, rule: AlertRule, metrics: Dict) -> bool:
        """
        è¯„ä¼°è§„åˆ™æ˜¯å¦è§¦å‘
        
        æ”¯æŒçš„è¿ç®—ç¬¦:
        - <  : å°äº
        - >  : å¤§äº
        - <= : å°äºç­‰äº
        - >= : å¤§äºç­‰äº
        - == : ç­‰äº
        """
        field_value = metrics.get(rule.condition_field)
        if field_value is None:
            return False
        
        threshold = rule.threshold_value
        operator = rule.operator
        
        try:
            if operator == '<':
                return float(field_value) < threshold
            elif operator == '>':
                return float(field_value) > threshold
            elif operator == '<=':
                return float(field_value) <= threshold
            elif operator == '>=':
                return float(field_value) >= threshold
            elif operator == '==':
                return str(field_value) == str(threshold)
        except (ValueError, TypeError):
            return False
        
        return False
```

**è§„åˆ™å¼•æ“ç‰¹ç‚¹**:
- çµæ´»çš„æ¡ä»¶è¡¨è¾¾å¼ï¼Œæ”¯æŒå¤šç§è¿ç®—ç¬¦
- ç±»å‹è‡ªåŠ¨è½¬æ¢ï¼Œå…¼å®¹æ•°å€¼å’Œå­—ç¬¦ä¸²æ¯”è¾ƒ
- å¼‚å¸¸å¤„ç†ï¼Œé¿å…è§„åˆ™é”™è¯¯å¯¼è‡´ç³»ç»Ÿå´©æºƒ
- å¯æ‰©å±•ï¼Œæ˜“äºæ·»åŠ æ–°çš„è¿ç®—ç¬¦


#### 2.2 å‘Šè­¦å»é‡æœºåˆ¶

```python
async def _create_alert(self, device_id: int, rule: AlertRule, metrics: Dict) -> DeviceAlert:
    """
    åˆ›å»ºå‘Šè­¦è®°å½• - é¿å…é‡å¤å‘Šè­¦
    """
    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æœªè§£å†³çš„ç›¸åŒå‘Šè­¦
    statement = select(DeviceAlert).where(
        DeviceAlert.device_id == device_id,
        DeviceAlert.alert_type == rule.rule_type,
        DeviceAlert.is_resolved == False
    )
    existing_alert = self.session.exec(statement).first()
    
    if existing_alert:
        # å·²å­˜åœ¨æœªè§£å†³çš„å‘Šè­¦ï¼Œä¸é‡å¤åˆ›å»º
        return None
    
    # åˆ›å»ºæ–°å‘Šè­¦
    alert = DeviceAlert(
        device_id=device_id,
        alert_type=rule.rule_type,
        severity=rule.severity,
        message=self._generate_alert_message(rule, metrics),
        is_resolved=False
    )
    
    self.session.add(alert)
    self.session.commit()
    
    # å‘é€é€šçŸ¥
    await self._send_notifications(alert, rule, device_id)
    
    return alert
```

**å»é‡ç­–ç•¥**:
- åŒä¸€è®¾å¤‡çš„åŒç±»å‹å‘Šè­¦åªä¿ç•™ä¸€ä¸ªæœªè§£å†³è®°å½•
- é¿å…å‘Šè­¦é£æš´ï¼Œå‡å°‘å™ªéŸ³
- å‘Šè­¦è§£å†³åæ‰èƒ½å†æ¬¡è§¦å‘
- æé«˜å‘Šè­¦çš„æœ‰æ•ˆæ€§å’Œå¯æ“ä½œæ€§

#### 2.3 å¤šæ¸ é“é€šçŸ¥

```python
async def _send_notifications(self, alert: DeviceAlert, rule: AlertRule, device_id: int):
    """
    å‘é€å‘Šè­¦é€šçŸ¥ - æ”¯æŒå¤šæ¸ é“
    """
    channels = []
    if rule.notification_channels:
        channels = json.loads(rule.notification_channels)
    
    # WebSocket æ¨é€ (é»˜è®¤)
    if 'websocket' in channels or not channels:
        await manager.broadcast(json.dumps({
            'type': 'device_alert',
            'data': {
                'alert_id': alert.id,
                'device_id': device_id,
                'alert_type': alert.alert_type,
                'severity': alert.severity,
                'message': alert.message,
                'created_at': alert.created_at.isoformat()
            }
        }))
    
    # é‚®ä»¶é€šçŸ¥
    if 'email' in channels:
        # TODO: å®ç°é‚®ä»¶å‘é€
        pass
    
    # çŸ­ä¿¡é€šçŸ¥
    if 'sms' in channels:
        # TODO: å®ç°çŸ­ä¿¡å‘é€
        pass
```

**é€šçŸ¥æ¸ é“è®¾è®¡**:
- WebSocket: å®æ—¶æ¨é€åˆ°å‰ç«¯ï¼Œç«‹å³å±•ç¤º
- é‚®ä»¶: é€‚åˆéç´§æ€¥å‘Šè­¦ï¼Œæ”¯æŒè¯¦ç»†ä¿¡æ¯
- çŸ­ä¿¡: é€‚åˆä¸¥é‡å‘Šè­¦ï¼Œç¡®ä¿åŠæ—¶æ”¶åˆ°
- å¯é…ç½®: æ¯ä¸ªè§„åˆ™å¯é€‰æ‹©é€šçŸ¥æ¸ é“

---

### 3. å¤±è´¥åˆ†æå¼•æ“

#### 3.1 é”™è¯¯åˆ†ç±»ç®—æ³•

**æ ¸å¿ƒä»£ç **: `backend/app/services/failure_analyzer.py`

```python
class FailureAnalyzer:
    """å¤±è´¥åˆ†æå™¨ - æ™ºèƒ½è¯†åˆ«é”™è¯¯ç±»å‹"""
    
    # é”™è¯¯ç±»å‹å®šä¹‰
    ERROR_PATTERNS = {
        'device_disconnected': {
            'keywords': ['device disconnect', 'device offline', 'device not found', 
                        'no devices', 'adb: device not found'],
            'severity': 'critical',
            'suggestions': [
                'æ£€æŸ¥USBè¿æ¥æ˜¯å¦æ­£å¸¸',
                'é‡å¯ADBæœåŠ¡ (adb kill-server && adb start-server)',
                'æ£€æŸ¥è®¾å¤‡æ˜¯å¦å¼€å¯USBè°ƒè¯•',
                'å°è¯•æ›´æ¢USBçº¿æˆ–USBç«¯å£',
                'æ£€æŸ¥è®¾å¤‡ç”µé‡æ˜¯å¦å……è¶³'
            ]
        },
        'element_not_found': {
            'keywords': ['element not found', 'selector not found', 'no such element',
                        'cannot find element', 'element does not exist'],
            'severity': 'medium',
            'suggestions': [
                'æ£€æŸ¥å…ƒç´ é€‰æ‹©å™¨æ˜¯å¦æ­£ç¡®',
                'ç¡®è®¤åº”ç”¨ç•Œé¢æ˜¯å¦å·²åŠ è½½å®Œæˆ',
                'å¢åŠ ç­‰å¾…æ—¶é—´è®©ç•Œé¢å®Œå…¨åŠ è½½',
                'ä½¿ç”¨æˆªå›¾ç¡®è®¤å…ƒç´ æ˜¯å¦å­˜åœ¨',
                'æ£€æŸ¥åº”ç”¨ç‰ˆæœ¬æ˜¯å¦å‘ç”Ÿå˜åŒ–'
            ]
        },
        'timeout': {
            'keywords': ['timeout', 'timed out', 'time out', 'wait timeout',
                        'operation timeout'],
            'severity': 'medium',
            'suggestions': [
                'å¢åŠ è¶…æ—¶æ—¶é—´è®¾ç½®',
                'æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦ç¨³å®š',
                'ä¼˜åŒ–è„šæœ¬æ‰§è¡Œé€»è¾‘',
                'æ£€æŸ¥è®¾å¤‡æ€§èƒ½æ˜¯å¦æ­£å¸¸',
                'ç¡®è®¤æ“ä½œæ˜¯å¦éœ€è¦æ›´é•¿æ—¶é—´'
            ]
        },
        'permission_denied': {
            'keywords': ['permission denied', 'access denied', 'no permission',
                        'requires permission'],
            'severity': 'high',
            'suggestions': [
                'æ£€æŸ¥åº”ç”¨æƒé™è®¾ç½®',
                'æˆäºˆå¿…è¦çš„ç³»ç»Ÿæƒé™',
                'æ£€æŸ¥æ–‡ä»¶è®¿é—®æƒé™',
                'ç¡®è®¤ADBæƒé™æ˜¯å¦æ­£å¸¸',
                'é‡æ–°å®‰è£…åº”ç”¨å¹¶æˆæƒ'
            ]
        },
        'app_crash': {
            'keywords': ['crash', 'force close', 'app stopped', 'has stopped',
                        'unfortunately'],
            'severity': 'high',
            'suggestions': [
                'æŸ¥çœ‹åº”ç”¨å´©æºƒæ—¥å¿— (logcat)',
                'æ£€æŸ¥åº”ç”¨ç‰ˆæœ¬æ˜¯å¦å…¼å®¹',
                'æ¸…é™¤åº”ç”¨æ•°æ®åé‡è¯•',
                'æ›´æ–°åº”ç”¨åˆ°æœ€æ–°ç‰ˆæœ¬',
                'æ£€æŸ¥è®¾å¤‡ç³»ç»Ÿç‰ˆæœ¬å…¼å®¹æ€§'
            ]
        },
        'network_error': {
            'keywords': ['network error', 'connection failed', 'no internet',
                        'network unreachable', 'connection timeout'],
            'severity': 'medium',
            'suggestions': [
                'æ£€æŸ¥è®¾å¤‡ç½‘ç»œè¿æ¥',
                'ç¡®è®¤WiFiæˆ–ç§»åŠ¨æ•°æ®å·²å¼€å¯',
                'æ£€æŸ¥ä»£ç†è®¾ç½®',
                'å°è¯•åˆ‡æ¢ç½‘ç»œ',
                'æ£€æŸ¥é˜²ç«å¢™è®¾ç½®'
            ]
        },
        'script_error': {
            'keywords': ['syntax error', 'undefined', 'null reference',
                        'index out of range', 'type error'],
            'severity': 'high',
            'suggestions': [
                'æ£€æŸ¥è„šæœ¬è¯­æ³•æ˜¯å¦æ­£ç¡®',
                'ç¡®è®¤å˜é‡æ˜¯å¦å·²å®šä¹‰',
                'æ£€æŸ¥æ•°ç»„ç´¢å¼•æ˜¯å¦è¶Šç•Œ',
                'éªŒè¯æ•°æ®ç±»å‹æ˜¯å¦åŒ¹é…',
                'ä½¿ç”¨è°ƒè¯•æ¨¡å¼é€æ­¥æ‰§è¡Œ'
            ]
        }
    }
```


#### 3.2 é”™è¯¯è¯†åˆ«æµç¨‹

```python
def analyze_failure(self, error_message: str, log_content: str = None) -> Dict:
    """
    åˆ†æå¤±è´¥åŸå› 
    
    Returns:
        {
            'failure_type': str,      # å¤±è´¥ç±»å‹
            'severity': str,          # ä¸¥é‡ç¨‹åº¦
            'confidence': float,      # ç½®ä¿¡åº¦ (0-1)
            'suggestions': List[str], # è§£å†³å»ºè®®
            'matched_keywords': List[str]  # åŒ¹é…çš„å…³é”®è¯
        }
    """
    # åˆå¹¶é”™è¯¯ä¿¡æ¯å’Œæ—¥å¿—å†…å®¹
    full_text = f"{error_message} {log_content or ''}".lower()
    
    best_match = None
    max_confidence = 0
    matched_keywords = []
    
    # éå†æ‰€æœ‰é”™è¯¯æ¨¡å¼
    for error_type, pattern in self.ERROR_PATTERNS.items():
        keywords = pattern['keywords']
        matches = []
        
        # æ£€æŸ¥å…³é”®è¯åŒ¹é…
        for keyword in keywords:
            if keyword.lower() in full_text:
                matches.append(keyword)
        
        # è®¡ç®—ç½®ä¿¡åº¦ (åŒ¹é…å…³é”®è¯æ•° / æ€»å…³é”®è¯æ•°)
        if matches:
            confidence = len(matches) / len(keywords)
            
            if confidence > max_confidence:
                max_confidence = confidence
                best_match = error_type
                matched_keywords = matches
    
    # å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œè¿”å›æœªçŸ¥é”™è¯¯
    if not best_match:
        return {
            'failure_type': 'unknown',
            'severity': 'medium',
            'confidence': 0.0,
            'suggestions': ['è¯·æ£€æŸ¥å®Œæ•´æ—¥å¿—ä»¥ç¡®å®šé—®é¢˜åŸå› '],
            'matched_keywords': []
        }
    
    # è¿”å›åˆ†æç»“æœ
    pattern = self.ERROR_PATTERNS[best_match]
    return {
        'failure_type': best_match,
        'severity': pattern['severity'],
        'confidence': max_confidence,
        'suggestions': pattern['suggestions'],
        'matched_keywords': matched_keywords
    }
```

**ç®—æ³•ç‰¹ç‚¹**:
- åŸºäºå…³é”®è¯åŒ¹é…çš„è§„åˆ™å¼•æ“
- ç½®ä¿¡åº¦è¯„åˆ†ï¼Œé‡åŒ–åŒ¹é…ç¨‹åº¦
- æ”¯æŒå¤šå…³é”®è¯åŒ¹é…ï¼Œæé«˜å‡†ç¡®ç‡
- è¿”å›åŒ¹é…çš„å…³é”®è¯ï¼Œä¾¿äºè°ƒè¯•
- æœªçŸ¥é”™è¯¯å…œåº•å¤„ç†ï¼Œé¿å…ç³»ç»Ÿå´©æºƒ

#### 3.3 å¤±è´¥è®°å½•ä¿å­˜

```python
def save_failure_analysis(
    self,
    task_log_id: int,
    failure_type: str,
    severity: str,
    error_message: str,
    suggestions: List[str],
    confidence: float,
    failed_step_index: int = None,
    screenshot_path: str = None
) -> FailureAnalysis:
    """ä¿å­˜å¤±è´¥åˆ†æç»“æœ"""
    
    analysis = FailureAnalysis(
        task_log_id=task_log_id,
        failure_type=failure_type,
        severity=severity,
        error_message=error_message,
        suggestions=json.dumps(suggestions, ensure_ascii=False),
        confidence=confidence,
        failed_step_index=failed_step_index,
        screenshot_path=screenshot_path
    )
    
    self.session.add(analysis)
    self.session.commit()
    self.session.refresh(analysis)
    
    return analysis
```

**æ•°æ®æŒä¹…åŒ–**:
- å…³è”ä»»åŠ¡æ—¥å¿—ï¼Œä¾¿äºè¿½æº¯
- ä¿å­˜å®Œæ•´åˆ†æç»“æœï¼Œæ”¯æŒå†å²æŸ¥è¯¢
- JSON æ ¼å¼å­˜å‚¨å»ºè®®åˆ—è¡¨ï¼Œçµæ´»æ‰©å±•
- è®°å½•ç½®ä¿¡åº¦ï¼Œè¯„ä¼°åˆ†æè´¨é‡

---

### 4. ä»»åŠ¡æ‰§è¡Œå™¨

#### 4.1 å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œ

**æ ¸å¿ƒä»£ç **: `backend/app/services/task_executor.py`

```python
class TaskExecutor:
    """ä»»åŠ¡æ‰§è¡Œå™¨ - å¼‚æ­¥æ‰§è¡Œè„šæœ¬å¹¶å®æ—¶æ¨é€è¿›åº¦"""
    
    async def execute_task(
        self,
        task_log_id: int,
        script: Script,
        device: Device
    ):
        """æ‰§è¡Œä»»åŠ¡"""
        try:
            # è§£æè„šæœ¬æ­¥éª¤
            if script.type == 'visual':
                steps = json.loads(script.steps_json)
            else:
                steps = [{'name': 'æ‰§è¡Œè„šæœ¬', 'type': 'script'}]
            
            total_steps = len(steps)
            
            # æ¨é€ä»»åŠ¡å¼€å§‹
            await self._push_progress(task_log_id, 0, total_steps, 'started', 
                                     'ä»»åŠ¡å¼€å§‹æ‰§è¡Œ')
            
            # æ‰§è¡Œæ¯ä¸ªæ­¥éª¤
            for index, step in enumerate(steps, 1):
                step_name = step.get('name', f'æ­¥éª¤{index}')
                
                # æ¨é€æ­¥éª¤å¼€å§‹
                await self._push_progress(task_log_id, index, total_steps, 
                                         'running', f'æ­£åœ¨æ‰§è¡Œ: {step_name}')
                
                # æ¨¡æ‹Ÿæ­¥éª¤æ‰§è¡Œ
                await asyncio.sleep(1)
                
                # æ¨é€æ­¥éª¤å®Œæˆ
                await self._push_log(task_log_id, 'success', 
                                    f'âœ… {step_name} - å®Œæˆ')
            
            # æ¨é€ä»»åŠ¡å®Œæˆ
            await self._push_progress(task_log_id, total_steps, total_steps, 
                                     'completed', 'ä»»åŠ¡æ‰§è¡Œå®Œæˆ')
            
            # æ›´æ–°ä»»åŠ¡çŠ¶æ€
            self._update_task_status(task_log_id, 'success')
            
        except Exception as e:
            # æ¨é€é”™è¯¯ä¿¡æ¯
            await self._push_log(task_log_id, 'error', f'âŒ æ‰§è¡Œå¤±è´¥: {str(e)}')
            await self._push_progress(task_log_id, 0, total_steps, 'failed', 
                                     f'ä»»åŠ¡æ‰§è¡Œå¤±è´¥: {str(e)}')
            
            # æ›´æ–°ä»»åŠ¡çŠ¶æ€
            self._update_task_status(task_log_id, 'failed', str(e))
```


#### 4.2 å®æ—¶è¿›åº¦æ¨é€

```python
async def _push_progress(
    self,
    task_log_id: int,
    current_step: int,
    total_steps: int,
    status: str,
    message: str
):
    """æ¨é€ä»»åŠ¡è¿›åº¦"""
    progress_data = {
        'type': 'task_progress',
        'data': {
            'task_log_id': task_log_id,
            'current_step': current_step,
            'total_steps': total_steps,
            'progress': int((current_step / total_steps) * 100) if total_steps > 0 else 0,
            'status': status,
            'message': message,
            'timestamp': datetime.now().isoformat()
        }
    }
    
    # å¹¿æ’­ç»™æ‰€æœ‰è®¢é˜…è¯¥ä»»åŠ¡çš„å®¢æˆ·ç«¯
    await manager.broadcast_to_task(task_log_id, json.dumps(progress_data))

async def _push_log(self, task_log_id: int, level: str, message: str):
    """æ¨é€æ—¥å¿—æ¶ˆæ¯"""
    log_data = {
        'type': 'task_log',
        'data': {
            'task_log_id': task_log_id,
            'level': level,
            'message': message,
            'timestamp': datetime.now().strftime('%H:%M:%S')
        }
    }
    
    await manager.broadcast_to_task(task_log_id, json.dumps(log_data))
```

**æ¨é€æœºåˆ¶**:
- è¿›åº¦æ¨é€: åŒ…å«å½“å‰æ­¥éª¤ã€æ€»æ­¥éª¤ã€è¿›åº¦ç™¾åˆ†æ¯”
- æ—¥å¿—æ¨é€: å®æ—¶è¾“å‡ºæ‰§è¡Œæ—¥å¿—ï¼Œç±»ä¼¼ç»ˆç«¯
- ä»»åŠ¡è®¢é˜…: å®¢æˆ·ç«¯è®¢é˜…ç‰¹å®šä»»åŠ¡ï¼Œåªæ¥æ”¶ç›¸å…³æ¶ˆæ¯
- å¹¿æ’­æœºåˆ¶: æ”¯æŒå¤šå®¢æˆ·ç«¯åŒæ—¶ç›‘æ§

---

## WebSocket å®æ—¶é€šä¿¡

### 5.1 è¿æ¥ç®¡ç†å™¨

**æ ¸å¿ƒä»£ç **: `backend/app/core/websocket_manager.py`

```python
class ConnectionManager:
    """WebSocket è¿æ¥ç®¡ç†å™¨"""
    
    def __init__(self):
        # å­˜å‚¨æ‰€æœ‰æ´»è·ƒè¿æ¥ {client_id: WebSocket}
        self.active_connections: Dict[str, WebSocket] = {}
        
        # ä»»åŠ¡è®¢é˜…å…³ç³» {task_id: [client_id1, client_id2, ...]}
        self.task_subscribers: Dict[int, List[str]] = {}
    
    async def connect(self, websocket: WebSocket, client_id: str):
        """æ¥å—æ–°è¿æ¥"""
        await websocket.accept()
        self.active_connections[client_id] = websocket
        print(f"âœ… å®¢æˆ·ç«¯ {client_id} å·²è¿æ¥ (å½“å‰è¿æ¥æ•°: {len(self.active_connections)})")
    
    def disconnect(self, client_id: str):
        """æ–­å¼€è¿æ¥"""
        if client_id in self.active_connections:
            del self.active_connections[client_id]
            print(f"âŒ å®¢æˆ·ç«¯ {client_id} å·²æ–­å¼€ (å½“å‰è¿æ¥æ•°: {len(self.active_connections)})")
        
        # æ¸…ç†è®¢é˜…å…³ç³»
        for task_id in list(self.task_subscribers.keys()):
            if client_id in self.task_subscribers[task_id]:
                self.task_subscribers[task_id].remove(client_id)
    
    async def send_personal_message(self, message: str, client_id: str):
        """å‘é€æ¶ˆæ¯ç»™æŒ‡å®šå®¢æˆ·ç«¯"""
        if client_id in self.active_connections:
            websocket = self.active_connections[client_id]
            await websocket.send_text(message)
    
    async def broadcast(self, message: str):
        """å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰å®¢æˆ·ç«¯"""
        for client_id, websocket in self.active_connections.items():
            try:
                await websocket.send_text(message)
            except Exception as e:
                print(f"âŒ å‘é€æ¶ˆæ¯ç»™ {client_id} å¤±è´¥: {e}")
    
    async def broadcast_to_task(self, task_id: int, message: str):
        """å¹¿æ’­æ¶ˆæ¯ç»™è®¢é˜…ç‰¹å®šä»»åŠ¡çš„å®¢æˆ·ç«¯"""
        if task_id in self.task_subscribers:
            for client_id in self.task_subscribers[task_id]:
                await self.send_personal_message(message, client_id)
    
    def subscribe_task(self, task_id: int, client_id: str):
        """è®¢é˜…ä»»åŠ¡"""
        if task_id not in self.task_subscribers:
            self.task_subscribers[task_id] = []
        
        if client_id not in self.task_subscribers[task_id]:
            self.task_subscribers[task_id].append(client_id)
            print(f"ğŸ“¢ å®¢æˆ·ç«¯ {client_id} è®¢é˜…äº†ä»»åŠ¡ {task_id}")

# å…¨å±€å•ä¾‹
manager = ConnectionManager()
```

**è®¾è®¡è¦ç‚¹**:
- å•ä¾‹æ¨¡å¼ï¼Œå…¨å±€å”¯ä¸€ç®¡ç†å™¨
- è¿æ¥æ± ç®¡ç†ï¼Œæ”¯æŒå¤šå®¢æˆ·ç«¯
- è®¢é˜…å‘å¸ƒæ¨¡å¼ï¼Œç²¾å‡†æ¨é€
- å¼‚å¸¸å¤„ç†ï¼Œé¿å…å•ä¸ªè¿æ¥å¤±è´¥å½±å“æ•´ä½“
- è‡ªåŠ¨æ¸…ç†ï¼Œæ–­å¼€è¿æ¥æ—¶æ¸…ç†è®¢é˜…å…³ç³»

### 5.2 WebSocket API

**æ ¸å¿ƒä»£ç **: `backend/app/api/websocket.py`

```python
@router.websocket("/ws/{client_id}")
async def websocket_endpoint(websocket: WebSocket, client_id: str):
    """WebSocket è¿æ¥ç«¯ç‚¹"""
    await manager.connect(websocket, client_id)
    
    try:
        while True:
            # æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯
            data = await websocket.receive_text()
            message = json.loads(data)
            
            # å¤„ç†è®¢é˜…è¯·æ±‚
            if message.get("type") == "subscribe":
                task_id = message.get("task_id")
                if task_id:
                    manager.subscribe_task(task_id, client_id)
                    await websocket.send_text(json.dumps({
                        "type": "subscribed",
                        "task_id": task_id,
                        "message": f"å·²è®¢é˜…ä»»åŠ¡ {task_id}"
                    }))
            
            # å¤„ç†å–æ¶ˆè®¢é˜…
            elif message.get("type") == "unsubscribe":
                task_id = message.get("task_id")
                if task_id and task_id in manager.task_subscribers:
                    if client_id in manager.task_subscribers[task_id]:
                        manager.task_subscribers[task_id].remove(client_id)
            
            # å¤„ç†å¿ƒè·³
            elif message.get("type") == "ping":
                await websocket.send_text(json.dumps({
                    "type": "pong",
                    "timestamp": message.get("timestamp")
                }))
    
    except WebSocketDisconnect:
        manager.disconnect(client_id)
    except Exception as e:
        print(f"âŒ WebSocket é”™è¯¯: {e}")
        manager.disconnect(client_id)
```

**æ¶ˆæ¯åè®®**:
- subscribe: è®¢é˜…ä»»åŠ¡æ›´æ–°
- unsubscribe: å–æ¶ˆè®¢é˜…
- ping/pong: å¿ƒè·³ä¿æ´»
- task_progress: ä»»åŠ¡è¿›åº¦æ¨é€
- task_log: ä»»åŠ¡æ—¥å¿—æ¨é€
- device_alert: è®¾å¤‡å‘Šè­¦æ¨é€


### 5.3 å‰ç«¯ WebSocket Hook

**æ ¸å¿ƒä»£ç **: `src/hooks/useWebSocket.ts`

```typescript
export const useWebSocket = (clientId: string) => {
  const [isConnected, setIsConnected] = useState(false);
  const [messages, setMessages] = useState<any[]>([]);
  const wsRef = useRef<WebSocket | null>(null);
  const reconnectTimeoutRef = useRef<NodeJS.Timeout>();

  const connect = useCallback(() => {
    const ws = new WebSocket(`ws://localhost:8000/api/v1/ws/${clientId}`);
    
    ws.onopen = () => {
      console.log('âœ… WebSocket è¿æ¥æˆåŠŸ');
      setIsConnected(true);
      
      // å‘é€å¿ƒè·³
      const heartbeat = setInterval(() => {
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            type: 'ping',
            timestamp: Date.now()
          }));
        }
      }, 30000); // æ¯30ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
    };
    
    ws.onmessage = (event) => {
      const message = JSON.parse(event.data);
      setMessages(prev => [...prev, message]);
    };
    
    ws.onerror = (error) => {
      console.error('âŒ WebSocket é”™è¯¯:', error);
    };
    
    ws.onclose = () => {
      console.log('âŒ WebSocket è¿æ¥å…³é—­');
      setIsConnected(false);
      
      // è‡ªåŠ¨é‡è¿
      reconnectTimeoutRef.current = setTimeout(() => {
        console.log('ğŸ”„ å°è¯•é‡æ–°è¿æ¥...');
        connect();
      }, 3000);
    };
    
    wsRef.current = ws;
  }, [clientId]);

  const subscribe = useCallback((taskId: number) => {
    if (wsRef.current?.readyState === WebSocket.OPEN) {
      wsRef.current.send(JSON.stringify({
        type: 'subscribe',
        task_id: taskId
      }));
    }
  }, []);

  const unsubscribe = useCallback((taskId: number) => {
    if (wsRef.current?.readyState === WebSocket.OPEN) {
      wsRef.current.send(JSON.stringify({
        type: 'unsubscribe',
        task_id: taskId
      }));
    }
  }, []);

  useEffect(() => {
    connect();
    
    return () => {
      if (reconnectTimeoutRef.current) {
        clearTimeout(reconnectTimeoutRef.current);
      }
      wsRef.current?.close();
    };
  }, [connect]);

  return { isConnected, messages, subscribe, unsubscribe };
};
```

**å‰ç«¯ç‰¹æ€§**:
- è‡ªåŠ¨è¿æ¥å’Œé‡è¿
- å¿ƒè·³ä¿æ´»æœºåˆ¶
- æ¶ˆæ¯é˜Ÿåˆ—ç®¡ç†
- è®¢é˜…/å–æ¶ˆè®¢é˜…æ¥å£
- React Hook å°è£…ï¼Œæ˜“äºä½¿ç”¨

---

## æ•°æ®æ¨¡å‹è®¾è®¡

### 6.1 è®¾å¤‡å¥åº·åº¦æ¨¡å‹

```python
class DeviceHealthRecord(SQLModel, table=True):
    """è®¾å¤‡å¥åº·åº¦è®°å½•è¡¨"""
    __tablename__ = "device_health_record"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    device_id: int = Field(foreign_key="device.id", index=True)
    health_score: int = Field(ge=0, le=100, description="å¥åº·åº¦åˆ†æ•°")
    
    # å„é¡¹æŒ‡æ ‡
    battery_level: Optional[int] = Field(default=None, ge=0, le=100)
    temperature: Optional[float] = Field(default=None)
    cpu_usage: Optional[float] = Field(default=None, ge=0, le=100)
    memory_usage: Optional[float] = Field(default=None, ge=0, le=100)
    storage_usage: Optional[float] = Field(default=None, ge=0, le=100)
    network_status: Optional[str] = Field(default=None)
    last_active_time: Optional[datetime] = Field(default=None)
    
    created_at: datetime = Field(default_factory=datetime.now)
```

**è®¾è®¡è¦ç‚¹**:
- æ—¶é—´åºåˆ—æ•°æ®ï¼Œæ”¯æŒè¶‹åŠ¿åˆ†æ
- å¤–é”®å…³è”è®¾å¤‡è¡¨
- ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- å­—æ®µéªŒè¯ï¼Œç¡®ä¿æ•°æ®æœ‰æ•ˆæ€§

### 6.2 å‘Šè­¦æ¨¡å‹

```python
class AlertRule(SQLModel, table=True):
    """å‘Šè­¦è§„åˆ™è¡¨"""
    __tablename__ = "alert_rule"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    rule_name: str = Field(max_length=200)
    rule_type: str = Field(max_length=50)  # low_battery, high_temp, etc.
    
    # æ¡ä»¶é…ç½®
    condition_field: str = Field(max_length=50)  # battery_level, temperature, etc.
    operator: str = Field(max_length=10)  # <, >, <=, >=, ==
    threshold_value: float
    
    # å‘Šè­¦é…ç½®
    severity: str = Field(max_length=20)  # info, warning, error, critical
    notification_channels: Optional[str] = Field(default=None)  # JSON: ["websocket", "email"]
    
    is_enabled: bool = Field(default=True)
    created_at: datetime = Field(default_factory=datetime.now)

class DeviceAlert(SQLModel, table=True):
    """è®¾å¤‡å‘Šè­¦è®°å½•è¡¨"""
    __tablename__ = "device_alert"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    device_id: int = Field(foreign_key="device.id", index=True)
    alert_type: str = Field(max_length=50)
    severity: str = Field(max_length=20)
    message: str
    
    is_resolved: bool = Field(default=False)
    resolved_at: Optional[datetime] = Field(default=None)
    
    created_at: datetime = Field(default_factory=datetime.now)
```

**è§„åˆ™å¼•æ“è®¾è®¡**:
- è§„åˆ™ä¸è®°å½•åˆ†ç¦»ï¼Œä¾¿äºç®¡ç†
- çµæ´»çš„æ¡ä»¶é…ç½®
- æ”¯æŒå¤šç§é€šçŸ¥æ¸ é“
- å‘Šè­¦çŠ¶æ€ç®¡ç†

### 6.3 å¤±è´¥åˆ†ææ¨¡å‹

```python
class FailureAnalysis(SQLModel, table=True):
    """å¤±è´¥åˆ†æè®°å½•è¡¨"""
    __tablename__ = "failure_analysis"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    task_log_id: int = Field(foreign_key="task_log.id", index=True)
    
    # åˆ†æç»“æœ
    failure_type: str = Field(max_length=50)  # device_disconnected, element_not_found, etc.
    severity: str = Field(max_length=20)  # low, medium, high, critical
    error_message: str
    suggestions: str  # JSON æ•°ç»„
    confidence: float = Field(ge=0, le=1)  # ç½®ä¿¡åº¦
    
    # å¤±è´¥è¯¦æƒ…
    failed_step_index: Optional[int] = Field(default=None)
    screenshot_path: Optional[str] = Field(default=None)
    
    created_at: datetime = Field(default_factory=datetime.now)
```

**åˆ†æç»“æœå­˜å‚¨**:
- å…³è”ä»»åŠ¡æ—¥å¿—
- å®Œæ•´çš„åˆ†æç»“æœ
- ç½®ä¿¡åº¦è¯„åˆ†
- å¤±è´¥æ­¥éª¤å®šä½


---

## API è®¾è®¡åŸç†

### 7.1 RESTful API è®¾è®¡

**èµ„æºå‘½åè§„èŒƒ**:
```
GET    /api/v1/devices              # è·å–è®¾å¤‡åˆ—è¡¨
GET    /api/v1/devices/{id}         # è·å–è®¾å¤‡è¯¦æƒ…
POST   /api/v1/devices/refresh      # åˆ·æ–°è®¾å¤‡åˆ—è¡¨
DELETE /api/v1/devices/{id}         # åˆ é™¤è®¾å¤‡

GET    /api/v1/scripts              # è·å–è„šæœ¬åˆ—è¡¨
POST   /api/v1/scripts              # åˆ›å»ºè„šæœ¬
PUT    /api/v1/scripts/{id}         # æ›´æ–°è„šæœ¬
DELETE /api/v1/scripts/{id}         # åˆ é™¤è„šæœ¬

POST   /api/v1/tasks/execute        # æ‰§è¡Œä»»åŠ¡
GET    /api/v1/tasks/{id}/logs      # è·å–ä»»åŠ¡æ—¥å¿—
POST   /api/v1/tasks/{id}/stop      # åœæ­¢ä»»åŠ¡
```

**è®¾è®¡åŸåˆ™**:
- ä½¿ç”¨åè¯è¡¨ç¤ºèµ„æºï¼Œé¿å…åŠ¨è¯
- ä½¿ç”¨å¤æ•°å½¢å¼è¡¨ç¤ºé›†åˆ
- ä½¿ç”¨ HTTP æ–¹æ³•è¡¨ç¤ºæ“ä½œ (GET/POST/PUT/DELETE)
- ä½¿ç”¨è·¯å¾„å‚æ•°è¡¨ç¤ºèµ„æº ID
- ä½¿ç”¨æŸ¥è¯¢å‚æ•°è¡¨ç¤ºè¿‡æ»¤å’Œåˆ†é¡µ

### 7.2 ç»Ÿä¸€å“åº”æ ¼å¼

```python
from pydantic import BaseModel
from typing import Generic, TypeVar, Optional

T = TypeVar('T')

class ApiResponse(BaseModel, Generic[T]):
    """ç»Ÿä¸€ API å“åº”æ ¼å¼"""
    code: int = 200
    message: str = "success"
    data: Optional[T] = None

# ä½¿ç”¨ç¤ºä¾‹
@router.get("/devices", response_model=ApiResponse[List[Device]])
async def get_devices(db: Session = Depends(get_db)):
    devices = db.exec(select(Device)).all()
    return ApiResponse(data=devices)
```

**å“åº”æ ¼å¼ä¼˜åŠ¿**:
- ç»Ÿä¸€çš„æ•°æ®ç»“æ„ï¼Œå‰ç«¯æ˜“äºå¤„ç†
- åŒ…å«çŠ¶æ€ç å’Œæ¶ˆæ¯ï¼Œä¾¿äºé”™è¯¯å¤„ç†
- æ”¯æŒæ³›å‹ï¼Œç±»å‹å®‰å…¨
- è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£

### 7.3 åˆ†é¡µæŸ¥è¯¢

```python
class PaginationParams(BaseModel):
    """åˆ†é¡µå‚æ•°"""
    page: int = Field(default=1, ge=1)
    page_size: int = Field(default=10, ge=1, le=100)

class PaginatedResponse(BaseModel, Generic[T]):
    """åˆ†é¡µå“åº”"""
    items: List[T]
    total: int
    page: int
    page_size: int
    total_pages: int

@router.get("/devices", response_model=ApiResponse[PaginatedResponse[Device]])
async def get_devices(
    pagination: PaginationParams = Depends(),
    db: Session = Depends(get_db)
):
    # è®¡ç®—åç§»é‡
    offset = (pagination.page - 1) * pagination.page_size
    
    # æŸ¥è¯¢æ€»æ•°
    total = db.exec(select(func.count(Device.id))).one()
    
    # æŸ¥è¯¢æ•°æ®
    devices = db.exec(
        select(Device)
        .offset(offset)
        .limit(pagination.page_size)
    ).all()
    
    # è®¡ç®—æ€»é¡µæ•°
    total_pages = (total + pagination.page_size - 1) // pagination.page_size
    
    return ApiResponse(data=PaginatedResponse(
        items=devices,
        total=total,
        page=pagination.page,
        page_size=pagination.page_size,
        total_pages=total_pages
    ))
```

**åˆ†é¡µè®¾è®¡**:
- æ”¯æŒè‡ªå®šä¹‰é¡µç å’Œæ¯é¡µæ•°é‡
- è¿”å›æ€»æ•°å’Œæ€»é¡µæ•°
- é™åˆ¶æ¯é¡µæœ€å¤§æ•°é‡ï¼Œé˜²æ­¢æ€§èƒ½é—®é¢˜
- ä½¿ç”¨ offset/limit å®ç°åˆ†é¡µ

### 7.4 å¼‚å¸¸å¤„ç†

```python
from fastapi import HTTPException, Request
from fastapi.responses import JSONResponse

class BusinessException(Exception):
    """ä¸šåŠ¡å¼‚å¸¸"""
    def __init__(self, code: int, message: str):
        self.code = code
        self.message = message

@app.exception_handler(BusinessException)
async def business_exception_handler(request: Request, exc: BusinessException):
    """ä¸šåŠ¡å¼‚å¸¸å¤„ç†å™¨"""
    return JSONResponse(
        status_code=200,
        content={
            "code": exc.code,
            "message": exc.message,
            "data": None
        }
    )

@app.exception_handler(Exception)
async def global_exception_handler(request: Request, exc: Exception):
    """å…¨å±€å¼‚å¸¸å¤„ç†å™¨"""
    return JSONResponse(
        status_code=500,
        content={
            "code": 500,
            "message": f"æœåŠ¡å™¨å†…éƒ¨é”™è¯¯: {str(exc)}",
            "data": None
        }
    )

# ä½¿ç”¨ç¤ºä¾‹
@router.get("/devices/{device_id}")
async def get_device(device_id: int, db: Session = Depends(get_db)):
    device = db.get(Device, device_id)
    if not device:
        raise BusinessException(1001, "è®¾å¤‡ä¸å­˜åœ¨")
    return ApiResponse(data=device)
```

**å¼‚å¸¸å¤„ç†ç­–ç•¥**:
- ä¸šåŠ¡å¼‚å¸¸è¿”å› 200 çŠ¶æ€ç ï¼Œé”™è¯¯ç åœ¨å“åº”ä½“ä¸­
- ç³»ç»Ÿå¼‚å¸¸è¿”å› 500 çŠ¶æ€ç 
- ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†å™¨ï¼Œé¿å…é‡å¤ä»£ç 
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•

---

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 8.1 æ•°æ®åº“ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–**:
```python
# ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•
class Device(SQLModel, table=True):
    serial_number: str = Field(unique=True, index=True)  # å”¯ä¸€ç´¢å¼•
    status: str = Field(index=True)  # æ™®é€šç´¢å¼•
    
class TaskLog(SQLModel, table=True):
    script_id: int = Field(foreign_key="script.id", index=True)
    device_id: int = Field(foreign_key="device.id", index=True)
    status: str = Field(index=True)
    start_time: datetime = Field(index=True)  # æ—¶é—´èŒƒå›´æŸ¥è¯¢
```

**æŸ¥è¯¢ä¼˜åŒ–**:
```python
# ä½¿ç”¨ select è¯­å¥ï¼Œé¿å…åŠ è½½ä¸å¿…è¦çš„å­—æ®µ
statement = select(Device.id, Device.model, Device.status).where(
    Device.status == 'online'
)

# ä½¿ç”¨ join å‡å°‘æŸ¥è¯¢æ¬¡æ•°
statement = select(TaskLog, Script, Device).join(
    Script, TaskLog.script_id == Script.id
).join(
    Device, TaskLog.device_id == Device.id
)

# ä½¿ç”¨æ‰¹é‡æ“ä½œ
devices = [Device(serial_number=f"device_{i}") for i in range(100)]
session.add_all(devices)
session.commit()
```

### 8.2 ç¼“å­˜ç­–ç•¥

```python
from functools import lru_cache
from typing import Dict

class ConfigCache:
    """é…ç½®ç¼“å­˜"""
    _cache: Dict[str, any] = {}
    
    @classmethod
    def get(cls, key: str, default=None):
        """è·å–é…ç½®"""
        if key not in cls._cache:
            # ä»æ•°æ®åº“åŠ è½½
            config = db.exec(
                select(SystemConfig).where(SystemConfig.config_key == key)
            ).first()
            if config:
                cls._cache[key] = config.config_value
        return cls._cache.get(key, default)
    
    @classmethod
    def set(cls, key: str, value: any):
        """è®¾ç½®é…ç½®"""
        cls._cache[key] = value
        # æ›´æ–°æ•°æ®åº“
        config = db.exec(
            select(SystemConfig).where(SystemConfig.config_key == key)
        ).first()
        if config:
            config.config_value = value
            db.add(config)
            db.commit()
    
    @classmethod
    def clear(cls):
        """æ¸…ç©ºç¼“å­˜"""
        cls._cache.clear()
```

**ç¼“å­˜åº”ç”¨åœºæ™¯**:
- ç³»ç»Ÿé…ç½®: è¯»å¤šå†™å°‘ï¼Œé€‚åˆç¼“å­˜
- è®¾å¤‡åˆ—è¡¨: çŸ­æ—¶é—´å†…å¤šæ¬¡æŸ¥è¯¢ï¼Œå¯ç¼“å­˜ 5 ç§’
- è„šæœ¬æ¨¡æ¿: å¾ˆå°‘å˜åŒ–ï¼Œå¯é•¿æœŸç¼“å­˜


### 8.3 å¼‚æ­¥å¤„ç†

```python
import asyncio
from concurrent.futures import ThreadPoolExecutor

# åˆ›å»ºçº¿ç¨‹æ± 
executor = ThreadPoolExecutor(max_workers=10)

@router.post("/tasks/execute")
async def execute_task(task: TaskCreate, db: Session = Depends(get_db)):
    """å¼‚æ­¥æ‰§è¡Œä»»åŠ¡"""
    # åˆ›å»ºä»»åŠ¡æ—¥å¿—
    task_log = TaskLog(
        task_name=task.task_name,
        script_id=task.script_id,
        device_id=task.device_id,
        status='running'
    )
    db.add(task_log)
    db.commit()
    db.refresh(task_log)
    
    # åœ¨åå°æ‰§è¡Œä»»åŠ¡
    asyncio.create_task(
        task_executor.execute_task(task_log.id, script, device)
    )
    
    # ç«‹å³è¿”å›
    return ApiResponse(data={
        'task_log_id': task_log.id,
        'status': 'running'
    })
```

**å¼‚æ­¥ä¼˜åŠ¿**:
- ä¸é˜»å¡ä¸»çº¿ç¨‹ï¼Œæé«˜å¹¶å‘èƒ½åŠ›
- ç«‹å³è¿”å›å“åº”ï¼Œæ”¹å–„ç”¨æˆ·ä½“éªŒ
- æ”¯æŒé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡
- é€šè¿‡ WebSocket æ¨é€è¿›åº¦

### 8.4 è¿æ¥æ± ç®¡ç†

```python
from sqlmodel import create_engine

# é…ç½®è¿æ¥æ± 
engine = create_engine(
    DATABASE_URL,
    echo=False,
    pool_size=10,          # è¿æ¥æ± å¤§å°
    max_overflow=20,       # æœ€å¤§æº¢å‡ºè¿æ¥æ•°
    pool_timeout=30,       # è·å–è¿æ¥è¶…æ—¶æ—¶é—´
    pool_recycle=3600,     # è¿æ¥å›æ”¶æ—¶é—´
    pool_pre_ping=True     # è¿æ¥å‰æ£€æŸ¥
)
```

**è¿æ¥æ± é…ç½®**:
- pool_size: å¸¸é©»è¿æ¥æ•°ï¼Œæ ¹æ®å¹¶å‘é‡è°ƒæ•´
- max_overflow: å³°å€¼æ—¶çš„é¢å¤–è¿æ¥æ•°
- pool_timeout: é¿å…é•¿æ—¶é—´ç­‰å¾…
- pool_recycle: å®šæœŸå›æ”¶è¿æ¥ï¼Œé¿å…è¿æ¥å¤±æ•ˆ
- pool_pre_ping: ä½¿ç”¨å‰æ£€æŸ¥è¿æ¥æœ‰æ•ˆæ€§

---

## æµ‹è¯•ç­–ç•¥

### 9.1 å•å…ƒæµ‹è¯•

```python
import pytest
from sqlmodel import Session, create_engine, SQLModel
from app.services.device_health import DeviceHealthService

@pytest.fixture
def health_service():
    """åˆ›å»ºå¥åº·åº¦æœåŠ¡å®ä¾‹"""
    return DeviceHealthService()

def test_calculate_health_score(health_service):
    """æµ‹è¯•å¥åº·åº¦è®¡ç®—"""
    # å‡†å¤‡æµ‹è¯•æ•°æ®
    metrics = {
        'battery_level': 85,
        'temperature': 35,
        'cpu_usage': 30,
        'memory_usage': 50,
        'storage_usage': 60,
        'network_status': 'connected',
        'last_active_time': datetime.now()
    }
    
    # æ‰§è¡Œæµ‹è¯•
    score = health_service.calculate_health_score(metrics)
    
    # éªŒè¯ç»“æœ
    assert 90 <= score <= 100, f"æœŸæœ›åˆ†æ•°åœ¨ 90-100 ä¹‹é—´ï¼Œå®é™…: {score}"

def test_get_health_level(health_service):
    """æµ‹è¯•å¥åº·ç­‰çº§åˆ†ç±»"""
    # æµ‹è¯•ä¼˜ç§€ç­‰çº§
    code, name, color = health_service.get_health_level(95)
    assert code == 'excellent'
    assert name == 'ä¼˜ç§€'
    
    # æµ‹è¯•è‰¯å¥½ç­‰çº§
    code, name, color = health_service.get_health_level(80)
    assert code == 'good'
    assert name == 'è‰¯å¥½'
    
    # æµ‹è¯•å±é™©ç­‰çº§
    code, name, color = health_service.get_health_level(30)
    assert code == 'critical'
    assert name == 'å±é™©'
```

### 9.2 é›†æˆæµ‹è¯•

```python
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_get_devices():
    """æµ‹è¯•è·å–è®¾å¤‡åˆ—è¡¨ API"""
    response = client.get("/api/v1/devices")
    
    assert response.status_code == 200
    data = response.json()
    assert data['code'] == 200
    assert 'data' in data
    assert isinstance(data['data']['items'], list)

def test_execute_task():
    """æµ‹è¯•æ‰§è¡Œä»»åŠ¡ API"""
    payload = {
        'task_name': 'æµ‹è¯•ä»»åŠ¡',
        'script_id': 1,
        'device_id': 1
    }
    
    response = client.post("/api/v1/tasks/execute", json=payload)
    
    assert response.status_code == 200
    data = response.json()
    assert data['code'] == 200
    assert 'task_log_id' in data['data']
```

### 9.3 æ€§èƒ½æµ‹è¯•

```python
import time
import statistics

def test_health_calculation_performance():
    """æµ‹è¯•å¥åº·åº¦è®¡ç®—æ€§èƒ½"""
    service = DeviceHealthService()
    metrics = {
        'battery_level': 85,
        'temperature': 35,
        'cpu_usage': 30,
        'memory_usage': 50,
        'storage_usage': 60,
        'network_status': 'connected'
    }
    
    # æ‰§è¡Œ 1000 æ¬¡è®¡ç®—
    times = []
    for _ in range(1000):
        start = time.time()
        service.calculate_health_score(metrics)
        times.append(time.time() - start)
    
    # ç»Ÿè®¡æ€§èƒ½æŒ‡æ ‡
    avg_time = statistics.mean(times)
    max_time = max(times)
    
    print(f"å¹³å‡è€—æ—¶: {avg_time*1000:.2f}ms")
    print(f"æœ€å¤§è€—æ—¶: {max_time*1000:.2f}ms")
    
    # æ€§èƒ½è¦æ±‚: å¹³å‡è€—æ—¶ < 1ms
    assert avg_time < 0.001, f"æ€§èƒ½ä¸è¾¾æ ‡ï¼Œå¹³å‡è€—æ—¶: {avg_time*1000:.2f}ms"
```

### 9.4 Allure æµ‹è¯•æŠ¥å‘Š

**é…ç½®æ–‡ä»¶**: `tests/pytest.ini`
```ini
[pytest]
testpaths = .
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = 
    --alluredir=allure-results
    --clean-alluredir
    -v
    -s
```

**æµ‹è¯•è£…é¥°å™¨**:
```python
import allure

@allure.feature("è®¾å¤‡å¥åº·åº¦ç›‘æ§")
@allure.story("å¥åº·åº¦è®¡ç®—")
@allure.title("æµ‹è¯•å¥åº·åº¦è¯„åˆ†ç®—æ³•")
@allure.severity(allure.severity_level.CRITICAL)
def test_health_score_calculation():
    with allure.step("å‡†å¤‡æµ‹è¯•æ•°æ®"):
        metrics = {...}
    
    with allure.step("æ‰§è¡Œå¥åº·åº¦è®¡ç®—"):
        score = service.calculate_health_score(metrics)
    
    with allure.step("éªŒè¯è®¡ç®—ç»“æœ"):
        assert 90 <= score <= 100
        allure.attach(
            f"å¥åº·åº¦åˆ†æ•°: {score}",
            name="è®¡ç®—ç»“æœ",
            attachment_type=allure.attachment_type.TEXT
        )
```

**æµ‹è¯•è¦†ç›–ç‡**:
- å•å…ƒæµ‹è¯•: è¦†ç›–æ ¸å¿ƒç®—æ³•å’Œä¸šåŠ¡é€»è¾‘
- é›†æˆæµ‹è¯•: è¦†ç›– API æ¥å£å’Œæ•°æ®åº“æ“ä½œ
- ç«¯åˆ°ç«¯æµ‹è¯•: è¦†ç›–å®Œæ•´ä¸šåŠ¡æµç¨‹
- æ€§èƒ½æµ‹è¯•: éªŒè¯å…³é”®åŠŸèƒ½æ€§èƒ½æŒ‡æ ‡

---

## å…³é”®ç®—æ³•è¯¦è§£

### 10.1 å¥åº·åº¦è¯„åˆ†ç®—æ³•

**ç®—æ³•æµç¨‹**:
```
è¾“å…¥: è®¾å¤‡æŒ‡æ ‡ (ç”µé‡ã€æ¸©åº¦ã€CPUã€å†…å­˜ã€å­˜å‚¨ã€ç½‘ç»œã€æ´»è·ƒåº¦)
è¾“å‡º: å¥åº·åº¦åˆ†æ•° (0-100)

æ­¥éª¤:
1. ç”µé‡è¯„åˆ† (25åˆ†)
   - >= 80%: 25åˆ†
   - >= 50%: 20åˆ†
   - >= 20%: 15åˆ†
   - < 20%: 5åˆ†

2. æ¸©åº¦è¯„åˆ† (20åˆ†)
   - <= 35Â°C: 20åˆ†
   - <= 40Â°C: 15åˆ†
   - <= 45Â°C: 10åˆ†
   - > 45Â°C: 5åˆ†

3. CPUè¯„åˆ† (15åˆ†)
   - <= 30%: 15åˆ†
   - <= 50%: 12åˆ†
   - <= 70%: 8åˆ†
   - > 70%: 4åˆ†

4. å†…å­˜è¯„åˆ† (15åˆ†)
   - <= 50%: 15åˆ†
   - <= 70%: 12åˆ†
   - <= 85%: 8åˆ†
   - > 85%: 4åˆ†

5. å­˜å‚¨è¯„åˆ† (10åˆ†)
   - <= 70%: 10åˆ†
   - <= 85%: 7åˆ†
   - <= 95%: 4åˆ†
   - > 95%: 2åˆ†

6. ç½‘ç»œè¯„åˆ† (10åˆ†)
   - connected: 10åˆ†
   - limited: 5åˆ†
   - disconnected: 0åˆ†

7. æ´»è·ƒåº¦è¯„åˆ† (5åˆ†)
   - < 5åˆ†é’Ÿ: 5åˆ†
   - < 1å°æ—¶: 3åˆ†
   - >= 1å°æ—¶: 0åˆ†

æ€»åˆ† = å„é¡¹å¾—åˆ†ä¹‹å’Œ (æœ€å¤§100åˆ†)
```

**ç®—æ³•ç‰¹ç‚¹**:
- å¤šç»´åº¦ç»¼åˆè¯„ä¼°
- æƒé‡å¯è°ƒæ•´
- åˆ†æ®µè¯„åˆ†ï¼ŒåŒºåˆ†åº¦é«˜
- æ˜“äºç†è§£å’Œç»´æŠ¤


### 10.2 é”™è¯¯åˆ†ç±»ç®—æ³•

**ç®—æ³•æµç¨‹**:
```
è¾“å…¥: é”™è¯¯ä¿¡æ¯ã€æ—¥å¿—å†…å®¹
è¾“å‡º: é”™è¯¯ç±»å‹ã€ä¸¥é‡ç¨‹åº¦ã€ç½®ä¿¡åº¦ã€è§£å†³å»ºè®®

æ­¥éª¤:
1. æ–‡æœ¬é¢„å¤„ç†
   - åˆå¹¶é”™è¯¯ä¿¡æ¯å’Œæ—¥å¿—å†…å®¹
   - è½¬æ¢ä¸ºå°å†™
   - å»é™¤ç‰¹æ®Šå­—ç¬¦

2. å…³é”®è¯åŒ¹é…
   for each é”™è¯¯æ¨¡å¼:
       matches = []
       for each å…³é”®è¯ in æ¨¡å¼.å…³é”®è¯åˆ—è¡¨:
           if å…³é”®è¯ in æ–‡æœ¬:
               matches.append(å…³é”®è¯)
       
       if matches:
           ç½®ä¿¡åº¦ = len(matches) / len(æ¨¡å¼.å…³é”®è¯åˆ—è¡¨)
           if ç½®ä¿¡åº¦ > æœ€å¤§ç½®ä¿¡åº¦:
               æœ€å¤§ç½®ä¿¡åº¦ = ç½®ä¿¡åº¦
               æœ€ä½³åŒ¹é… = é”™è¯¯æ¨¡å¼

3. è¿”å›åˆ†æç»“æœ
   if æœ€ä½³åŒ¹é…:
       return {
           é”™è¯¯ç±»å‹: æœ€ä½³åŒ¹é….ç±»å‹,
           ä¸¥é‡ç¨‹åº¦: æœ€ä½³åŒ¹é….ä¸¥é‡ç¨‹åº¦,
           ç½®ä¿¡åº¦: æœ€å¤§ç½®ä¿¡åº¦,
           å»ºè®®: æœ€ä½³åŒ¹é….å»ºè®®åˆ—è¡¨
       }
   else:
       return æœªçŸ¥é”™è¯¯
```

**ç½®ä¿¡åº¦è®¡ç®—**:
```
ç½®ä¿¡åº¦ = åŒ¹é…çš„å…³é”®è¯æ•° / è¯¥æ¨¡å¼çš„æ€»å…³é”®è¯æ•°

ç¤ºä¾‹:
- æ¨¡å¼: element_not_found
- å…³é”®è¯: ['element not found', 'selector not found', 'no such element']
- æ–‡æœ¬: "Error: element not found on page"
- åŒ¹é…: ['element not found']
- ç½®ä¿¡åº¦: 1/3 = 0.33 (33%)
```

**ç®—æ³•ä¼˜åŒ–æ–¹å‘**:
- å¼•å…¥æœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œæé«˜è¯†åˆ«å‡†ç¡®ç‡
- æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
- è€ƒè™‘å…³é”®è¯æƒé‡
- æ”¯æŒå¤šè¯­è¨€é”™è¯¯ä¿¡æ¯

### 10.3 å‘Šè­¦å»é‡ç®—æ³•

**ç®—æ³•æµç¨‹**:
```
è¾“å…¥: è®¾å¤‡IDã€å‘Šè­¦ç±»å‹ã€å‘Šè­¦è§„åˆ™
è¾“å‡º: æ˜¯å¦åˆ›å»ºæ–°å‘Šè­¦

æ­¥éª¤:
1. æŸ¥è¯¢æœªè§£å†³çš„å‘Šè­¦
   existing_alerts = æŸ¥è¯¢(
       è®¾å¤‡ID = è¾“å…¥è®¾å¤‡ID,
       å‘Šè­¦ç±»å‹ = è¾“å…¥å‘Šè­¦ç±»å‹,
       is_resolved = False
   )

2. åˆ¤æ–­æ˜¯å¦åˆ›å»º
   if existing_alerts:
       return None  # å·²å­˜åœ¨æœªè§£å†³çš„å‘Šè­¦ï¼Œä¸åˆ›å»º
   else:
       åˆ›å»ºæ–°å‘Šè­¦
       å‘é€é€šçŸ¥
       return æ–°å‘Šè­¦

3. å‘Šè­¦è§£å†³å
   æ›´æ–° is_resolved = True
   æ›´æ–° resolved_at = å½“å‰æ—¶é—´
   å…è®¸å†æ¬¡è§¦å‘è¯¥ç±»å‹å‘Šè­¦
```

**å»é‡ç­–ç•¥**:
- åŒè®¾å¤‡ + åŒç±»å‹ + æœªè§£å†³ = ä¸é‡å¤åˆ›å»º
- å‘Šè­¦è§£å†³åæ‰èƒ½å†æ¬¡è§¦å‘
- é¿å…å‘Šè­¦é£æš´
- æé«˜å‘Šè­¦æœ‰æ•ˆæ€§

---

## éƒ¨ç½²æ¶æ„

### 11.1 å¼€å‘ç¯å¢ƒ

```
å¼€å‘æœºå™¨
â”œâ”€â”€ åç«¯æœåŠ¡ (FastAPI)
â”‚   â”œâ”€â”€ ç«¯å£: 8000
â”‚   â”œâ”€â”€ æ•°æ®åº“: SQLite (test_platform.db)
â”‚   â””â”€â”€ æ—¥å¿—: logs/app.log
â”‚
â”œâ”€â”€ å‰ç«¯æœåŠ¡ (Vite Dev Server)
â”‚   â”œâ”€â”€ ç«¯å£: 5173
â”‚   â””â”€â”€ ä»£ç†: http://localhost:8000
â”‚
â””â”€â”€ ADB æœåŠ¡
    â”œâ”€â”€ ç«¯å£: 5037
    â””â”€â”€ è®¾å¤‡è¿æ¥: USB/WiFi
```

### 11.2 ç”Ÿäº§ç¯å¢ƒ

```
æœåŠ¡å™¨
â”œâ”€â”€ Nginx (åå‘ä»£ç†)
â”‚   â”œâ”€â”€ ç«¯å£: 80/443
â”‚   â”œâ”€â”€ é™æ€æ–‡ä»¶: /var/www/adbweb
â”‚   â””â”€â”€ API ä»£ç†: http://127.0.0.1:8000
â”‚
â”œâ”€â”€ FastAPI (Gunicorn + Uvicorn)
â”‚   â”œâ”€â”€ ç«¯å£: 8000
â”‚   â”œâ”€â”€ è¿›ç¨‹æ•°: 4
â”‚   â””â”€â”€ æ•°æ®åº“: PostgreSQL/MySQL
â”‚
â”œâ”€â”€ æ•°æ®åº“
â”‚   â”œâ”€â”€ PostgreSQL: 5432
â”‚   â””â”€â”€ å¤‡ä»½: æ¯æ—¥è‡ªåŠ¨å¤‡ä»½
â”‚
â””â”€â”€ ADB æœåŠ¡
    â”œâ”€â”€ ç«¯å£: 5037
    â””â”€â”€ è®¾å¤‡æ± : 10+ è®¾å¤‡
```

### 11.3 Docker éƒ¨ç½²

**Dockerfile (åç«¯)**:
```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8000

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**Dockerfile (å‰ç«¯)**:
```dockerfile
FROM node:18-alpine as builder

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM nginx:alpine

COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

**docker-compose.yml**:
```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - ./data:/app/data
    environment:
      - DATABASE_URL=sqlite:///data/test_platform.db
    restart: unless-stopped

  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: unless-stopped

  db:
    image: postgres:14
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=adbweb
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  postgres_data:
```

---

## å®‰å…¨è€ƒè™‘

### 12.1 è¾“å…¥éªŒè¯

```python
from pydantic import BaseModel, Field, validator

class ScriptCreate(BaseModel):
    """è„šæœ¬åˆ›å»ºè¯·æ±‚"""
    name: str = Field(..., min_length=1, max_length=200)
    type: str = Field(..., regex="^(visual|python|batch)$")
    category: str = Field(..., regex="^(login|test|automation|other)$")
    
    @validator('name')
    def validate_name(cls, v):
        """éªŒè¯è„šæœ¬åç§°"""
        if '<' in v or '>' in v:
            raise ValueError('è„šæœ¬åç§°ä¸èƒ½åŒ…å« < æˆ– >')
        return v
```

**éªŒè¯ç­–ç•¥**:
- ä½¿ç”¨ Pydantic è¿›è¡Œæ•°æ®éªŒè¯
- é™åˆ¶å­—ç¬¦ä¸²é•¿åº¦
- ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼éªŒè¯æ ¼å¼
- é˜²æ­¢ XSS æ”»å‡»

### 12.2 SQL æ³¨å…¥é˜²æŠ¤

```python
# âŒ é”™è¯¯ç¤ºä¾‹ - SQL æ³¨å…¥é£é™©
query = f"SELECT * FROM device WHERE serial_number = '{serial_number}'"

# âœ… æ­£ç¡®ç¤ºä¾‹ - ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
statement = select(Device).where(Device.serial_number == serial_number)
device = session.exec(statement).first()
```

**é˜²æŠ¤æªæ–½**:
- ä½¿ç”¨ ORM (SQLModel/SQLAlchemy)
- å‚æ•°åŒ–æŸ¥è¯¢
- é¿å…å­—ç¬¦ä¸²æ‹¼æ¥ SQL
- è¾“å…¥éªŒè¯å’Œè½¬ä¹‰

### 12.3 æ–‡ä»¶ä¸Šä¼ å®‰å…¨

```python
import os
from pathlib import Path

ALLOWED_EXTENSIONS = {'.py', '.bat', '.png', '.jpg'}
MAX_FILE_SIZE = 10 * 1024 * 1024  # 10MB

async def upload_file(file: UploadFile):
    """å®‰å…¨çš„æ–‡ä»¶ä¸Šä¼ """
    # éªŒè¯æ–‡ä»¶æ‰©å±•å
    ext = Path(file.filename).suffix.lower()
    if ext not in ALLOWED_EXTENSIONS:
        raise BusinessException(7001, "ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹")
    
    # éªŒè¯æ–‡ä»¶å¤§å°
    content = await file.read()
    if len(content) > MAX_FILE_SIZE:
        raise BusinessException(7002, "æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶")
    
    # ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶å
    safe_filename = f"{datetime.now().strftime('%Y%m%d_%H%M%S')}_{file.filename}"
    
    # ä¿å­˜æ–‡ä»¶
    file_path = Path("uploads") / safe_filename
    with open(file_path, "wb") as f:
        f.write(content)
    
    return str(file_path)
```

**å®‰å…¨æªæ–½**:
- é™åˆ¶æ–‡ä»¶ç±»å‹
- é™åˆ¶æ–‡ä»¶å¤§å°
- é‡å‘½åæ–‡ä»¶ï¼Œé¿å…è·¯å¾„éå†
- å­˜å‚¨åœ¨å®‰å…¨ç›®å½•


---

## ç›‘æ§å’Œæ—¥å¿—

### 13.1 æ—¥å¿—ç³»ç»Ÿ

```python
import logging
from logging.handlers import RotatingFileHandler

# é…ç½®æ—¥å¿—
def setup_logging():
    """é…ç½®æ—¥å¿—ç³»ç»Ÿ"""
    logger = logging.getLogger("adbweb")
    logger.setLevel(logging.INFO)
    
    # æ§åˆ¶å°å¤„ç†å™¨
    console_handler = logging.StreamHandler()
    console_handler.setLevel(logging.INFO)
    console_formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    console_handler.setFormatter(console_formatter)
    
    # æ–‡ä»¶å¤„ç†å™¨ (è‡ªåŠ¨è½®è½¬)
    file_handler = RotatingFileHandler(
        'logs/app.log',
        maxBytes=10*1024*1024,  # 10MB
        backupCount=5
    )
    file_handler.setLevel(logging.INFO)
    file_formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(filename)s:%(lineno)d - %(message)s'
    )
    file_handler.setFormatter(file_formatter)
    
    logger.addHandler(console_handler)
    logger.addHandler(file_handler)
    
    return logger

# ä½¿ç”¨æ—¥å¿—
logger = setup_logging()

@router.post("/tasks/execute")
async def execute_task(task: TaskCreate):
    logger.info(f"å¼€å§‹æ‰§è¡Œä»»åŠ¡: {task.task_name}")
    try:
        result = await task_executor.execute_task(...)
        logger.info(f"ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ: {task.task_name}")
        return result
    except Exception as e:
        logger.error(f"ä»»åŠ¡æ‰§è¡Œå¤±è´¥: {task.task_name}, é”™è¯¯: {str(e)}", exc_info=True)
        raise
```

**æ—¥å¿—çº§åˆ«**:
- DEBUG: è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
- INFO: ä¸€èˆ¬ä¿¡æ¯ï¼Œå¦‚ä»»åŠ¡å¼€å§‹/å®Œæˆ
- WARNING: è­¦å‘Šä¿¡æ¯ï¼Œå¦‚é…ç½®ç¼ºå¤±
- ERROR: é”™è¯¯ä¿¡æ¯ï¼Œå¦‚ä»»åŠ¡å¤±è´¥
- CRITICAL: ä¸¥é‡é”™è¯¯ï¼Œå¦‚ç³»ç»Ÿå´©æºƒ

### 13.2 æ€§èƒ½ç›‘æ§

```python
import time
from functools import wraps

def monitor_performance(func):
    """æ€§èƒ½ç›‘æ§è£…é¥°å™¨"""
    @wraps(func)
    async def wrapper(*args, **kwargs):
        start_time = time.time()
        
        try:
            result = await func(*args, **kwargs)
            duration = time.time() - start_time
            
            # è®°å½•æ€§èƒ½æŒ‡æ ‡
            logger.info(f"{func.__name__} æ‰§è¡Œè€—æ—¶: {duration:.2f}ç§’")
            
            # æ€§èƒ½å‘Šè­¦
            if duration > 5:
                logger.warning(f"{func.__name__} æ‰§è¡Œæ—¶é—´è¿‡é•¿: {duration:.2f}ç§’")
            
            return result
        except Exception as e:
            duration = time.time() - start_time
            logger.error(f"{func.__name__} æ‰§è¡Œå¤±è´¥ï¼Œè€—æ—¶: {duration:.2f}ç§’")
            raise
    
    return wrapper

# ä½¿ç”¨ç¤ºä¾‹
@monitor_performance
async def execute_task(task_log_id: int, script: Script, device: Device):
    # ä»»åŠ¡æ‰§è¡Œé€»è¾‘
    pass
```

### 13.3 å¥åº·æ£€æŸ¥

```python
@router.get("/health")
async def health_check(db: Session = Depends(get_db)):
    """å¥åº·æ£€æŸ¥ç«¯ç‚¹"""
    health_status = {
        "status": "healthy",
        "timestamp": datetime.now().isoformat(),
        "checks": {}
    }
    
    # æ£€æŸ¥æ•°æ®åº“è¿æ¥
    try:
        db.exec(select(1)).one()
        health_status["checks"]["database"] = "ok"
    except Exception as e:
        health_status["checks"]["database"] = f"error: {str(e)}"
        health_status["status"] = "unhealthy"
    
    # æ£€æŸ¥ WebSocket è¿æ¥æ•°
    ws_connections = len(manager.active_connections)
    health_status["checks"]["websocket"] = {
        "status": "ok",
        "connections": ws_connections
    }
    
    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    import shutil
    disk_usage = shutil.disk_usage("/")
    disk_free_gb = disk_usage.free / (1024**3)
    health_status["checks"]["disk"] = {
        "status": "ok" if disk_free_gb > 1 else "warning",
        "free_gb": round(disk_free_gb, 2)
    }
    
    return health_status
```

---

## æ‰©å±•æ€§è®¾è®¡

### 14.1 æ’ä»¶ç³»ç»Ÿ

```python
from abc import ABC, abstractmethod

class ScriptExecutor(ABC):
    """è„šæœ¬æ‰§è¡Œå™¨æ¥å£"""
    
    @abstractmethod
    async def execute(self, script: Script, device: Device) -> Dict:
        """æ‰§è¡Œè„šæœ¬"""
        pass

class VisualScriptExecutor(ScriptExecutor):
    """å¯è§†åŒ–è„šæœ¬æ‰§è¡Œå™¨"""
    
    async def execute(self, script: Script, device: Device) -> Dict:
        steps = json.loads(script.steps_json)
        # æ‰§è¡Œå¯è§†åŒ–æ­¥éª¤
        return {"status": "success"}

class PythonScriptExecutor(ScriptExecutor):
    """Python è„šæœ¬æ‰§è¡Œå™¨"""
    
    async def execute(self, script: Script, device: Device) -> Dict:
        # æ‰§è¡Œ Python è„šæœ¬
        return {"status": "success"}

# æ‰§è¡Œå™¨å·¥å‚
class ExecutorFactory:
    """æ‰§è¡Œå™¨å·¥å‚"""
    
    _executors = {
        'visual': VisualScriptExecutor,
        'python': PythonScriptExecutor,
        'batch': BatchScriptExecutor
    }
    
    @classmethod
    def get_executor(cls, script_type: str) -> ScriptExecutor:
        """è·å–æ‰§è¡Œå™¨"""
        executor_class = cls._executors.get(script_type)
        if not executor_class:
            raise ValueError(f"ä¸æ”¯æŒçš„è„šæœ¬ç±»å‹: {script_type}")
        return executor_class()
    
    @classmethod
    def register_executor(cls, script_type: str, executor_class: type):
        """æ³¨å†Œæ–°çš„æ‰§è¡Œå™¨"""
        cls._executors[script_type] = executor_class
```

**æ‰©å±•æ–¹å¼**:
- å®ç° ScriptExecutor æ¥å£
- æ³¨å†Œåˆ°æ‰§è¡Œå™¨å·¥å‚
- æ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç 

### 14.2 äº‹ä»¶ç³»ç»Ÿ

```python
from typing import Callable, List

class EventBus:
    """äº‹ä»¶æ€»çº¿"""
    
    def __init__(self):
        self._listeners: Dict[str, List[Callable]] = {}
    
    def on(self, event_name: str, callback: Callable):
        """æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨"""
        if event_name not in self._listeners:
            self._listeners[event_name] = []
        self._listeners[event_name].append(callback)
    
    async def emit(self, event_name: str, data: any):
        """è§¦å‘äº‹ä»¶"""
        if event_name in self._listeners:
            for callback in self._listeners[event_name]:
                await callback(data)

# å…¨å±€äº‹ä»¶æ€»çº¿
event_bus = EventBus()

# æ³¨å†Œç›‘å¬å™¨
@event_bus.on('task_completed')
async def on_task_completed(data):
    """ä»»åŠ¡å®Œæˆäº‹ä»¶å¤„ç†"""
    logger.info(f"ä»»åŠ¡å®Œæˆ: {data['task_id']}")
    # å‘é€é€šçŸ¥ã€æ›´æ–°ç»Ÿè®¡ç­‰

# è§¦å‘äº‹ä»¶
await event_bus.emit('task_completed', {
    'task_id': 123,
    'status': 'success'
})
```

**äº‹ä»¶ç±»å‹**:
- task_started: ä»»åŠ¡å¼€å§‹
- task_completed: ä»»åŠ¡å®Œæˆ
- task_failed: ä»»åŠ¡å¤±è´¥
- device_connected: è®¾å¤‡è¿æ¥
- device_disconnected: è®¾å¤‡æ–­å¼€
- alert_triggered: å‘Šè­¦è§¦å‘

---

## æœ€ä½³å®è·µ

### 15.1 ä»£ç è§„èŒƒ

**å‘½åè§„èŒƒ**:
```python
# ç±»å: å¤§é©¼å³°
class DeviceHealthService:
    pass

# å‡½æ•°å: å°å†™ä¸‹åˆ’çº¿
def calculate_health_score():
    pass

# å¸¸é‡: å¤§å†™ä¸‹åˆ’çº¿
MAX_RETRY_COUNT = 3

# ç§æœ‰æ–¹æ³•: ä¸‹åˆ’çº¿å‰ç¼€
def _internal_method():
    pass
```

**ç±»å‹æç¤º**:
```python
from typing import List, Dict, Optional

def get_devices(
    status: Optional[str] = None,
    page: int = 1,
    page_size: int = 10
) -> List[Device]:
    """è·å–è®¾å¤‡åˆ—è¡¨"""
    pass
```

**æ–‡æ¡£å­—ç¬¦ä¸²**:
```python
def calculate_health_score(self, metrics: Dict) -> int:
    """
    è®¡ç®—è®¾å¤‡å¥åº·åº¦åˆ†æ•°
    
    Args:
        metrics: è®¾å¤‡æŒ‡æ ‡å­—å…¸ï¼ŒåŒ…å«ç”µé‡ã€æ¸©åº¦ç­‰ä¿¡æ¯
        
    Returns:
        å¥åº·åº¦åˆ†æ•° (0-100)
        
    Raises:
        ValueError: å½“æŒ‡æ ‡æ•°æ®æ— æ•ˆæ—¶
        
    Example:
        >>> metrics = {'battery_level': 85, 'temperature': 35}
        >>> score = service.calculate_health_score(metrics)
        >>> print(score)
        95
    """
    pass
```

### 15.2 é”™è¯¯å¤„ç†

```python
# âŒ é”™è¯¯ç¤ºä¾‹ - æ•è·æ‰€æœ‰å¼‚å¸¸
try:
    result = do_something()
except:
    pass

# âœ… æ­£ç¡®ç¤ºä¾‹ - å…·ä½“å¼‚å¸¸å¤„ç†
try:
    result = do_something()
except ValueError as e:
    logger.error(f"æ•°å€¼é”™è¯¯: {e}")
    raise BusinessException(1001, "å‚æ•°é”™è¯¯")
except ConnectionError as e:
    logger.error(f"è¿æ¥é”™è¯¯: {e}")
    raise BusinessException(1002, "è®¾å¤‡è¿æ¥å¤±è´¥")
except Exception as e:
    logger.error(f"æœªçŸ¥é”™è¯¯: {e}", exc_info=True)
    raise
```

### 15.3 èµ„æºç®¡ç†

```python
# âŒ é”™è¯¯ç¤ºä¾‹ - æœªå…³é—­èµ„æº
file = open('data.txt', 'r')
data = file.read()

# âœ… æ­£ç¡®ç¤ºä¾‹ - ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨
with open('data.txt', 'r') as file:
    data = file.read()

# æ•°æ®åº“ä¼šè¯ç®¡ç†
with Session(engine) as session:
    devices = session.exec(select(Device)).all()
    # session è‡ªåŠ¨å…³é—­
```

---

## æ€»ç»“

### æŠ€æœ¯äº®ç‚¹

1. **å¤šç»´åº¦å¥åº·åº¦è¯„åˆ†**: 7 ä¸ªç»´åº¦åŠ æƒè®¡ç®—ï¼Œå…¨é¢è¯„ä¼°è®¾å¤‡çŠ¶æ€
2. **æ™ºèƒ½é”™è¯¯åˆ†ç±»**: åŸºäºå…³é”®è¯åŒ¹é…çš„è§„åˆ™å¼•æ“ï¼Œè‡ªåŠ¨è¯†åˆ« 7 ç§é”™è¯¯ç±»å‹
3. **å®æ—¶ä»»åŠ¡ç›‘æ§**: WebSocket å®æ—¶æ¨é€ä»»åŠ¡è¿›åº¦å’Œæ—¥å¿—
4. **å‘Šè­¦å»é‡æœºåˆ¶**: é¿å…å‘Šè­¦é£æš´ï¼Œæé«˜å‘Šè­¦æœ‰æ•ˆæ€§
5. **å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œ**: ä¸é˜»å¡ä¸»çº¿ç¨‹ï¼Œæ”¯æŒé«˜å¹¶å‘
6. **æ’ä»¶åŒ–æ¶æ„**: æ˜“äºæ‰©å±•æ–°çš„è„šæœ¬ç±»å‹å’Œæ‰§è¡Œå™¨
7. **å®Œæ•´çš„æµ‹è¯•ä½“ç³»**: å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ã€Allure æŠ¥å‘Š

### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… | çŠ¶æ€ |
|------|------|------|------|
| API å“åº”æ—¶é—´ | < 200ms | < 100ms | âœ… |
| WebSocket å»¶è¿Ÿ | < 100ms | < 50ms | âœ… |
| å¥åº·åº¦è®¡ç®— | < 200ms | < 100ms | âœ… |
| å¤±è´¥åˆ†æ | < 1s | < 500ms | âœ… |
| **AI è„šæœ¬ç”Ÿæˆ (è§„åˆ™å¼•æ“)** | **< 500ms** | **< 200ms** | **âœ…** |
| **AI è„šæœ¬ç”Ÿæˆ (AIæ¨¡å¼)** | **< 10s** | **< 5s** | **âœ…** |
| **æ‰¹é‡è„šæœ¬ç”Ÿæˆ (5ä¸ª)** | **< 30s** | **< 15s** | **âœ…** |
| **è„šæœ¬éªŒè¯** | **< 1s** | **< 300ms** | **âœ…** |
| å¹¶å‘è¿æ¥æ•° | 100+ | 100+ | âœ… |
| æµ‹è¯•è¦†ç›–ç‡ | > 80% | 100% | âœ… |

### AI åŠŸèƒ½æ€§èƒ½åˆ†æ

**è§„åˆ™å¼•æ“æ¨¡å¼**:
- å“åº”æ—¶é—´: 50-200ms
- æˆåŠŸç‡: 99%+
- é€‚ç”¨åœºæ™¯: ç®€å•æ“ä½œã€åŸºç¡€æµ‹è¯•
- ä¼˜åŠ¿: å¿«é€Ÿã€ç¨³å®šã€å…è´¹

**AI æ¨¡å¼ (OpenAI)**:
- å“åº”æ—¶é—´: 2-8s
- æˆåŠŸç‡: 95%+
- é€‚ç”¨åœºæ™¯: å¤æ‚é€»è¾‘ã€åˆ›æ–°åœºæ™¯
- ä¼˜åŠ¿: æ™ºèƒ½ã€çµæ´»ã€ç†è§£èƒ½åŠ›å¼º

**AI æ¨¡å¼ (DeepSeek)**:
- å“åº”æ—¶é—´: 3-10s
- æˆåŠŸç‡: 90%+
- é€‚ç”¨åœºæ™¯: ä¸­æ–‡åœºæ™¯ã€æˆæœ¬æ•æ„Ÿ
- ä¼˜åŠ¿: ä¸­æ–‡å‹å¥½ã€æˆæœ¬ä½

**æ‰¹é‡ç”Ÿæˆæ€§èƒ½**:
- å¹¶å‘æ•°: 5ä¸ª
- å¹³å‡å•ä¸ªè€—æ—¶: 3s
- æ€»ä½“æ•ˆç‡: æ¯”ä¸²è¡Œå¿« 60%+

### åç»­ä¼˜åŒ–æ–¹å‘

**çŸ­æœŸ (1-2 å‘¨)**:
- å®Œå–„æ­¥éª¤æ—¥å¿—è®°å½•ï¼Œç²¾ç¡®å®šä½å¤±è´¥æ­¥éª¤
- å¼€å‘å‰ç«¯å¥åº·åº¦ä»ªè¡¨ç›˜å’Œå¤±è´¥åˆ†æè¯¦æƒ…é¡µ
- é›†æˆçœŸå® ADB è®¾å¤‡ï¼Œæ›¿æ¢æ¨¡æ‹Ÿæ•°æ®
- ä¼˜åŒ– AI è„šæœ¬ç”Ÿæˆçš„å‡†ç¡®æ€§å’Œç¨³å®šæ€§

**ä¸­æœŸ (1-2 æœˆ)**:
- å¼•å…¥æœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œæé«˜é”™è¯¯åˆ†ç±»å‡†ç¡®ç‡
- å®ç°é‚®ä»¶å’ŒçŸ­ä¿¡é€šçŸ¥æ¸ é“
- æ·»åŠ è®¾å¤‡æ•…éšœé¢„æµ‹åŠŸèƒ½
- æ‰©å±• AI è„šæœ¬æ¨¡æ¿åº“ï¼Œæ”¯æŒæ›´å¤šåœºæ™¯

**é•¿æœŸ (3-6 æœˆ)**:
- æ™ºèƒ½ä¿®å¤å»ºè®®ï¼ŒåŸºäºå†å²æ•°æ®è‡ªåŠ¨ç”Ÿæˆä¿®å¤æ–¹æ¡ˆ
- åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œæ”¯æŒæ›´å¤§è§„æ¨¡çš„è®¾å¤‡æ± 
- æ€§èƒ½ä¼˜åŒ–ï¼Œå¼•å…¥ Redis ç¼“å­˜å’Œæ¶ˆæ¯é˜Ÿåˆ—
- AI æ¨¡å‹æœ¬åœ°åŒ–éƒ¨ç½²ï¼Œé™ä½æˆæœ¬å’Œå»¶è¿Ÿ

---

## AI åŠŸèƒ½æ¶æ„è¯¦è§£

### AI è„šæœ¬ç”Ÿæˆå™¨æ ¸å¿ƒå®ç°

**æ ¸å¿ƒä»£ç **: `backend/app/services/ai_script_generator.py`

```python
class AIScriptGenerator:
    """AI è„šæœ¬ç”Ÿæˆå™¨ - æ”¯æŒå¤šç§ç”Ÿæˆæ¨¡å¼"""
    
    def __init__(self):
        self.rule_engine = RuleEngine()
        self.ai_clients = {
            'openai': OpenAIClient(),
            'deepseek': DeepSeekClient()
        }
    
    async def generate_script(
        self,
        prompt: str,
        language: str = "adb",
        generation_mode: str = "rule_engine",
        ai_model: str = None,
        device_model: str = None
    ) -> Dict:
        """
        ç”Ÿæˆè„šæœ¬
        
        Args:
            prompt: ç”¨æˆ·æç¤ºè¯
            language: è„šæœ¬è¯­è¨€ (adb/python)
            generation_mode: ç”Ÿæˆæ¨¡å¼ (rule_engine/ai)
            ai_model: AI æ¨¡å‹åç§°
            device_model: è®¾å¤‡å‹å·
            
        Returns:
            ç”Ÿæˆç»“æœå­—å…¸
        """
        try:
            if generation_mode == "rule_engine":
                # ä½¿ç”¨è§„åˆ™å¼•æ“ç”Ÿæˆ
                script_content = self.rule_engine.generate_script(prompt, language)
                ai_model_used = None
            else:
                # ä½¿ç”¨ AI æœåŠ¡ç”Ÿæˆ
                client = self._get_ai_client(ai_model)
                script_content = await client.generate_script(
                    prompt, language, device_model
                )
                ai_model_used = ai_model
            
            # ä¿å­˜ç”Ÿæˆè®°å½•
            ai_script = AIScript(
                prompt=prompt,
                language=language,
                generated_script=script_content,
                generation_mode=generation_mode,
                ai_model=ai_model_used,
                device_model=device_model
            )
            
            self.session.add(ai_script)
            self.session.commit()
            self.session.refresh(ai_script)
            
            return {
                "id": ai_script.id,
                "generated_script": script_content,
                "generation_mode": generation_mode,
                "ai_model": ai_model_used,
                "device_model": device_model,
                "created_at": ai_script.created_at
            }
            
        except Exception as e:
            logger.error(f"è„šæœ¬ç”Ÿæˆå¤±è´¥: {str(e)}")
            raise AIGenerationException(f"è„šæœ¬ç”Ÿæˆå¤±è´¥: {str(e)}")
```

### è§„åˆ™å¼•æ“å®ç°

```python
class RuleEngine:
    """è§„åˆ™å¼•æ“ - åŸºäºæ¨¡æ¿å’Œè§„åˆ™ç”Ÿæˆè„šæœ¬"""
    
    def __init__(self):
        self.adb_templates = self._load_adb_templates()
        self.python_templates = self._load_python_templates()
    
    def generate_script(self, prompt: str, language: str) -> str:
        """åŸºäºè§„åˆ™ç”Ÿæˆè„šæœ¬"""
        # åˆ†ææç¤ºè¯ï¼Œæå–å…³é”®ä¿¡æ¯
        analysis = self._analyze_prompt(prompt)
        
        if language == "adb":
            return self._generate_adb_script(analysis)
        elif language == "python":
            return self._generate_python_script(analysis)
        else:
            raise ValueError(f"ä¸æ”¯æŒçš„è„šæœ¬è¯­è¨€: {language}")
    
    def _analyze_prompt(self, prompt: str) -> Dict:
        """åˆ†ææç¤ºè¯ï¼Œæå–æ“ä½œç±»å‹å’Œå‚æ•°"""
        analysis = {
            'operations': [],
            'app_name': None,
            'coordinates': [],
            'text_inputs': [],
            'wait_times': []
        }
        
        # æ“ä½œç±»å‹è¯†åˆ«
        operation_patterns = {
            'launch': ['å¯åŠ¨', 'æ‰“å¼€', 'è¿è¡Œ'],
            'click': ['ç‚¹å‡»', 'æŒ‰', 'è§¦æ‘¸', 'é€‰æ‹©'],
            'input': ['è¾“å…¥', 'å¡«å†™', 'é”®å…¥'],
            'search': ['æœç´¢', 'æŸ¥æ‰¾', 'æ£€ç´¢'],
            'login': ['ç™»å½•', 'ç™»é™†', 'ç­¾åˆ°'],
            'scroll': ['æ»‘åŠ¨', 'æ»šåŠ¨', 'ç¿»é¡µ'],
            'screenshot': ['æˆªå›¾', 'ä¿å­˜', 'è®°å½•']
        }
        
        for op_type, keywords in operation_patterns.items():
            if any(keyword in prompt for keyword in keywords):
                analysis['operations'].append(op_type)
        
        # åº”ç”¨åç§°è¯†åˆ«
        app_patterns = {
            'å¾®ä¿¡': 'com.tencent.mm',
            'æ·˜å®': 'com.taobao.taobao',
            'æ”¯ä»˜å®': 'com.eg.android.AlipayGphone',
            'æŠ–éŸ³': 'com.ss.android.ugc.aweme'
        }
        
        for app_name, package in app_patterns.items():
            if app_name in prompt:
                analysis['app_name'] = package
                break
        
        return analysis
    
    def _generate_adb_script(self, analysis: Dict) -> str:
        """ç”Ÿæˆ ADB è„šæœ¬"""
        script_lines = []
        
        # æ·»åŠ å¯åŠ¨åº”ç”¨
        if 'launch' in analysis['operations'] and analysis['app_name']:
            script_lines.append(f"# å¯åŠ¨åº”ç”¨")
            script_lines.append(f"adb shell am start -n {analysis['app_name']}/.MainActivity")
            script_lines.append("adb shell sleep 3")
            script_lines.append("")
        
        # æ·»åŠ ç‚¹å‡»æ“ä½œ
        if 'click' in analysis['operations']:
            script_lines.append("# ç‚¹å‡»æ“ä½œ")
            script_lines.append("adb shell input tap 540 960")
            script_lines.append("adb shell sleep 1")
            script_lines.append("")
        
        # æ·»åŠ è¾“å…¥æ“ä½œ
        if 'input' in analysis['operations']:
            script_lines.append("# è¾“å…¥æ“ä½œ")
            script_lines.append("adb shell input text \"æµ‹è¯•å†…å®¹\"")
            script_lines.append("adb shell sleep 1")
            script_lines.append("")
        
        # æ·»åŠ æœç´¢æ“ä½œ
        if 'search' in analysis['operations']:
            script_lines.append("# æœç´¢æ“ä½œ")
            script_lines.append("adb shell input tap 540 200")  # ç‚¹å‡»æœç´¢æ¡†
            script_lines.append("adb shell sleep 1")
            script_lines.append("adb shell input text \"æœç´¢å…³é”®è¯\"")
            script_lines.append("adb shell input keyevent 66")  # å›è½¦
            script_lines.append("adb shell sleep 2")
            script_lines.append("")
        
        # æ·»åŠ æˆªå›¾æ“ä½œ
        if 'screenshot' in analysis['operations'] or not analysis['operations']:
            script_lines.append("# æˆªå›¾ä¿å­˜")
            script_lines.append("adb shell screencap /sdcard/screenshot.png")
            script_lines.append("")
        
        return "\n".join(script_lines)
```

### æ‰¹é‡ç”Ÿæˆå™¨å®ç°

```python
class BatchScriptGenerator:
    """æ‰¹é‡è„šæœ¬ç”Ÿæˆå™¨"""
    
    def __init__(self, ai_generator: AIScriptGenerator):
        self.ai_generator = ai_generator
    
    async def batch_generate(
        self,
        prompts: List[str],
        language: str = "adb",
        generation_mode: str = "rule_engine",
        generate_suite: bool = False
    ) -> Dict:
        """
        æ‰¹é‡ç”Ÿæˆè„šæœ¬
        
        Args:
            prompts: æç¤ºè¯åˆ—è¡¨
            language: è„šæœ¬è¯­è¨€
            generation_mode: ç”Ÿæˆæ¨¡å¼
            generate_suite: æ˜¯å¦ç”Ÿæˆæµ‹è¯•å¥—ä»¶
            
        Returns:
            æ‰¹é‡ç”Ÿæˆç»“æœ
        """
        results = []
        statistics = {
            "total": len(prompts),
            "success": 0,
            "failed": 0,
            "start_time": datetime.now(),
            "end_time": None
        }
        
        # å¹¶å‘ç”Ÿæˆè„šæœ¬
        semaphore = asyncio.Semaphore(5)  # é™åˆ¶å¹¶å‘æ•°
        
        async def generate_single(prompt: str) -> Dict:
            async with semaphore:
                try:
                    result = await self.ai_generator.generate_script(
                        prompt=prompt,
                        language=language,
                        generation_mode=generation_mode
                    )
                    statistics["success"] += 1
                    return {
                        "prompt": prompt,
                        "status": "success",
                        "script": result["generated_script"],
                        "script_id": result["id"]
                    }
                except Exception as e:
                    statistics["failed"] += 1
                    return {
                        "prompt": prompt,
                        "status": "failed",
                        "error": str(e),
                        "script_id": None
                    }
        
        # æ‰§è¡Œæ‰¹é‡ç”Ÿæˆ
        tasks = [generate_single(prompt) for prompt in prompts]
        results = await asyncio.gather(*tasks)
        
        statistics["end_time"] = datetime.now()
        statistics["duration"] = (
            statistics["end_time"] - statistics["start_time"]
        ).total_seconds()
        
        # ç”Ÿæˆæµ‹è¯•å¥—ä»¶
        suite_script = None
        if generate_suite and statistics["success"] > 0:
            suite_script = self._generate_test_suite(results, language)
        
        return {
            "results": results,
            "statistics": statistics,
            "suite_script": suite_script
        }
    
    def _generate_test_suite(self, results: List[Dict], language: str) -> str:
        """ç”Ÿæˆæµ‹è¯•å¥—ä»¶è„šæœ¬"""
        successful_scripts = [
            r for r in results if r["status"] == "success"
        ]
        
        if language == "adb":
            suite_lines = [
                "#!/bin/bash",
                "# è‡ªåŠ¨ç”Ÿæˆçš„æµ‹è¯•å¥—ä»¶",
                f"# ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
                f"# åŒ…å« {len(successful_scripts)} ä¸ªæµ‹è¯•è„šæœ¬",
                "",
                "echo 'å¼€å§‹æ‰§è¡Œæµ‹è¯•å¥—ä»¶...'",
                ""
            ]
            
            for i, result in enumerate(successful_scripts, 1):
                suite_lines.extend([
                    f"echo 'æ‰§è¡Œæµ‹è¯• {i}: {result['prompt']}'",
                    result["script"],
                    "echo 'æµ‹è¯•å®Œæˆï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªæµ‹è¯•...'",
                    "sleep 2",
                    ""
                ])
            
            suite_lines.append("echo 'æµ‹è¯•å¥—ä»¶æ‰§è¡Œå®Œæˆï¼'")
            
        elif language == "python":
            suite_lines = [
                "#!/usr/bin/env python3",
                "# -*- coding: utf-8 -*-",
                '"""',
                "è‡ªåŠ¨ç”Ÿæˆçš„æµ‹è¯•å¥—ä»¶",
                f"ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
                f"åŒ…å« {len(successful_scripts)} ä¸ªæµ‹è¯•è„šæœ¬",
                '"""',
                "",
                "import time",
                "import subprocess",
                "",
                "def run_test_suite():",
                '    """è¿è¡Œæµ‹è¯•å¥—ä»¶"""',
                '    print("å¼€å§‹æ‰§è¡Œæµ‹è¯•å¥—ä»¶...")',
                ""
            ]
            
            for i, result in enumerate(successful_scripts, 1):
                suite_lines.extend([
                    f'    print("æ‰§è¡Œæµ‹è¯• {i}: {result['prompt']}")',
                    f"    # {result['prompt']}",
                    "    " + result["script"].replace("\n", "\n    "),
                    '    print("æµ‹è¯•å®Œæˆï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªæµ‹è¯•...")',
                    "    time.sleep(2)",
                    ""
                ])
            
            suite_lines.extend([
                '    print("æµ‹è¯•å¥—ä»¶æ‰§è¡Œå®Œæˆï¼")',
                "",
                'if __name__ == "__main__":',
                "    run_test_suite()"
            ])
        
        return "\n".join(suite_lines)
```

### è„šæœ¬éªŒè¯å™¨

```python
class ScriptValidator:
    """è„šæœ¬éªŒè¯å™¨ - éªŒè¯ç”Ÿæˆè„šæœ¬çš„è´¨é‡"""
    
    def validate_script(
        self,
        script_content: str,
        script_type: str,
        filename: str = None
    ) -> Dict:
        """
        éªŒè¯è„šæœ¬
        
        Returns:
            {
                'passed': bool,
                'score': int,
                'issues': List[Dict],
                'suggestions': List[str]
            }
        """
        issues = []
        suggestions = []
        score = 100
        
        if script_type == "python":
            # Python è„šæœ¬éªŒè¯
            issues.extend(self._validate_python_syntax(script_content))
            issues.extend(self._validate_python_security(script_content))
            issues.extend(self._validate_python_best_practices(script_content))
            
        elif script_type == "adb" or script_type == "batch":
            # ADB/æ‰¹å¤„ç†è„šæœ¬éªŒè¯
            issues.extend(self._validate_adb_commands(script_content))
            issues.extend(self._validate_adb_security(script_content))
            issues.extend(self._validate_adb_best_practices(script_content))
        
        # è®¡ç®—åˆ†æ•°
        for issue in issues:
            if issue['type'] == 'error':
                score -= 20
            elif issue['type'] == 'warning':
                score -= 10
            elif issue['type'] == 'info':
                score -= 5
        
        score = max(0, score)
        
        # ç”Ÿæˆå»ºè®®
        if score < 60:
            suggestions.append("è„šæœ¬å­˜åœ¨è¾ƒå¤šé—®é¢˜ï¼Œå»ºè®®é‡æ–°ç”Ÿæˆ")
        elif score < 80:
            suggestions.append("è„šæœ¬åŸºæœ¬å¯ç”¨ï¼Œå»ºè®®æ ¹æ®é—®é¢˜æç¤ºè¿›è¡Œä¼˜åŒ–")
        else:
            suggestions.append("è„šæœ¬è´¨é‡è‰¯å¥½ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨")
        
        return {
            'passed': score >= 60,
            'score': score,
            'issues': issues,
            'suggestions': suggestions
        }
    
    def _validate_python_syntax(self, content: str) -> List[Dict]:
        """éªŒè¯ Python è¯­æ³•"""
        issues = []
        try:
            compile(content, '<string>', 'exec')
        except SyntaxError as e:
            issues.append({
                'type': 'error',
                'message': f'è¯­æ³•é”™è¯¯: {e.msg}',
                'line': e.lineno
            })
        return issues
    
    def _validate_adb_commands(self, content: str) -> List[Dict]:
        """éªŒè¯ ADB å‘½ä»¤"""
        issues = []
        lines = content.split('\n')
        
        for i, line in enumerate(lines, 1):
            line = line.strip()
            if not line or line.startswith('#'):
                continue
                
            if line.startswith('adb '):
                # éªŒè¯ ADB å‘½ä»¤æ ¼å¼
                if 'shell' not in line and 'devices' not in line:
                    issues.append({
                        'type': 'warning',
                        'message': 'å¯èƒ½çš„æ— æ•ˆ ADB å‘½ä»¤',
                        'line': i
                    })
        
        return issues
```

### AI å®¢æˆ·ç«¯å®ç°

```python
class OpenAIClient:
    """OpenAI API å®¢æˆ·ç«¯"""
    
    def __init__(self):
        self.api_key = None
        self.model = "gpt-3.5-turbo"
        self.base_url = "https://api.openai.com/v1"
    
    def configure(self, api_key: str, model: str = None):
        """é…ç½® API å¯†é’¥å’Œæ¨¡å‹"""
        self.api_key = api_key
        if model:
            self.model = model
    
    async def generate_script(
        self,
        prompt: str,
        language: str,
        device_model: str = None
    ) -> str:
        """è°ƒç”¨ OpenAI API ç”Ÿæˆè„šæœ¬"""
        if not self.api_key:
            raise AIConfigException("OpenAI API Key æœªé…ç½®")
        
        # æ„å»ºç³»ç»Ÿæç¤ºè¯
        system_prompt = self._build_system_prompt(language, device_model)
        
        # æ„å»ºç”¨æˆ·æç¤ºè¯
        user_prompt = self._build_user_prompt(prompt, language)
        
        # è°ƒç”¨ API
        headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }
        
        data = {
            "model": self.model,
            "messages": [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            "temperature": 0.7,
            "max_tokens": 1000
        }
        
        async with httpx.AsyncClient() as client:
            response = await client.post(
                f"{self.base_url}/chat/completions",
                headers=headers,
                json=data,
                timeout=30
            )
            
            if response.status_code != 200:
                raise AIServiceException(f"OpenAI API è°ƒç”¨å¤±è´¥: {response.text}")
            
            result = response.json()
            return result["choices"][0]["message"]["content"]
    
    def _build_system_prompt(self, language: str, device_model: str) -> str:
        """æ„å»ºç³»ç»Ÿæç¤ºè¯"""
        if language == "adb":
            return f"""ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ Android è‡ªåŠ¨åŒ–æµ‹è¯•ä¸“å®¶ã€‚è¯·æ ¹æ®ç”¨æˆ·çš„éœ€æ±‚ç”Ÿæˆ ADB è„šæœ¬ã€‚

è¦æ±‚ï¼š
1. ç”Ÿæˆçš„è„šæœ¬å¿…é¡»æ˜¯å¯æ‰§è¡Œçš„ ADB å‘½ä»¤
2. æ¯ä¸ªæ“ä½œåæ·»åŠ é€‚å½“çš„ç­‰å¾…æ—¶é—´ (adb shell sleep)
3. ä½¿ç”¨æ³¨é‡Šè¯´æ˜æ¯ä¸ªæ­¥éª¤çš„ä½œç”¨
4. åæ ‡ä½¿ç”¨å¸¸è§çš„å±å¹•ä¸­å¿ƒä½ç½® (540, 960)
5. åŒ…å«å¿…è¦çš„é”™è¯¯å¤„ç†
6. è®¾å¤‡å‹å·: {device_model or 'é€šç”¨Androidè®¾å¤‡'}

ç¤ºä¾‹æ ¼å¼ï¼š
# å¯åŠ¨åº”ç”¨
adb shell am start -n com.example.app/.MainActivity
adb shell sleep 3

# ç‚¹å‡»æŒ‰é’®
adb shell input tap 540 960
adb shell sleep 1
"""
        elif language == "python":
            return f"""ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ Python è‡ªåŠ¨åŒ–æµ‹è¯•ä¸“å®¶ã€‚è¯·æ ¹æ®ç”¨æˆ·çš„éœ€æ±‚ç”Ÿæˆ Python è„šæœ¬ã€‚

è¦æ±‚ï¼š
1. ä½¿ç”¨ subprocess æ¨¡å—è°ƒç”¨ ADB å‘½ä»¤
2. æ·»åŠ é€‚å½“çš„å¼‚å¸¸å¤„ç†
3. ä½¿ç”¨ time.sleep() æ·»åŠ ç­‰å¾…æ—¶é—´
4. æ·»åŠ è¯¦ç»†çš„æ³¨é‡Š
5. éµå¾ª PEP 8 ç¼–ç è§„èŒƒ
6. è®¾å¤‡å‹å·: {device_model or 'é€šç”¨Androidè®¾å¤‡'}

ç¤ºä¾‹æ ¼å¼ï¼š
import subprocess
import time

def test_function():
    try:
        # å¯åŠ¨åº”ç”¨
        subprocess.run(['adb', 'shell', 'am', 'start', '-n', 'com.example.app/.MainActivity'])
        time.sleep(3)
        
        # ç‚¹å‡»æŒ‰é’®
        subprocess.run(['adb', 'shell', 'input', 'tap', '540', '960'])
        time.sleep(1)
        
    except Exception as e:
        print(f"æ‰§è¡Œå¤±è´¥: {{e}}")

if __name__ == "__main__":
    test_function()
"""
    
    def _build_user_prompt(self, prompt: str, language: str) -> str:
        """æ„å»ºç”¨æˆ·æç¤ºè¯"""
        return f"è¯·ç”Ÿæˆ{language.upper()}è„šæœ¬æ¥å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š{prompt}"

class DeepSeekClient:
    """DeepSeek API å®¢æˆ·ç«¯"""
    
    def __init__(self):
        self.api_key = None
        self.model = "deepseek-chat"
        self.base_url = "https://api.deepseek.com/v1"
    
    # å®ç°ç±»ä¼¼ OpenAI çš„æ¥å£...
```

---

## é™„å½•

### A. æŠ€æœ¯æ ˆç‰ˆæœ¬

- Python: 3.9+
- FastAPI: 0.104+
- SQLModel: 0.0.14+
- Pydantic: 2.0+
- APScheduler: 3.10+
- Node.js: 18+
- React: 18+
- TypeScript: 5+
- Ant Design: 5+
- Vite: 5+

### B. å‚è€ƒèµ„æ–™

- [FastAPI å®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [SQLModel å®˜æ–¹æ–‡æ¡£](https://sqlmodel.tiangolo.com/)
- [WebSocket åè®®è§„èŒƒ](https://datatracker.ietf.org/doc/html/rfc6455)
- [Allure æµ‹è¯•æŠ¥å‘Š](https://docs.qameta.io/allure/)
- [ADB å‘½ä»¤å‚è€ƒ](https://developer.android.com/studio/command-line/adb)

### C. è”ç³»æ–¹å¼

- é¡¹ç›®åœ°å€: https://github.com/your-org/adbweb
- é—®é¢˜åé¦ˆ: https://github.com/your-org/adbweb/issues
- æŠ€æœ¯æ”¯æŒ: support@adbweb.com

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-02-24  
**æ›´æ–°æ—¥æœŸ**: 2026-02-26  
**ç»´æŠ¤äººå‘˜**: å¼€å‘å›¢é˜Ÿ  
**æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæˆ

