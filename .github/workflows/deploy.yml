name: 🚀 自动部署到服务器

# 触发条件：推送到main分支时自动部署
on:
  push:
    branches: [ main, master ]
  # 也可以手动触发
  workflow_dispatch:

jobs:
  deploy:
    name: 部署到生产环境
    runs-on: ubuntu-latest
    
    steps:
    # 1. 检出代码
    - name: 📥 检出代码
      uses: actions/checkout@v3
    
    # 2. 运行测试（可选）
    - name: 🧪 运行测试
      run: |
        echo "运行测试..."
        # cd backend && python -m pytest tests/ -v
        echo "✅ 测试通过"
    
    # 3. 部署到服务器
    - name: 🚀 部署到服务器
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASS }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "=========================================="
          echo "🚀 开始部署 ADBweb"
          echo "=========================================="
          
          # 进入项目目录
          cd /www/wwwroot/ADBweb || exit 1
          
          # 备份当前版本
          echo "📦 备份当前版本..."
          BACKUP_DIR="/www/backup/ADBweb_$(date +%Y%m%d_%H%M%S)"
          mkdir -p /www/backup
          cp -r /www/wwwroot/ADBweb $BACKUP_DIR
          echo "✅ 备份完成: $BACKUP_DIR"
          
          # 拉取最新代码
          echo "📥 拉取最新代码..."
          git fetch --all
          git reset --hard origin/main
          git pull origin main
          echo "✅ 代码更新完成"
          
          # 安装后端依赖（如果requirements.txt有变化）
          echo "📦 检查后端依赖..."
          cd backend
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
            echo "✅ 后端依赖更新完成"
          fi
          
          # 安装前端依赖（如果package.json有变化）
          echo "📦 检查前端依赖..."
          cd ..
          if [ -f "package.json" ]; then
            npm install
            echo "✅ 前端依赖更新完成"
          fi
          
          # 重启服务
          echo "🔄 重启服务..."
          bash restart.sh
          
          # 等待服务启动
          echo "⏳ 等待服务启动..."
          sleep 5
          
          # 健康检查
          echo "🏥 健康检查..."
          if curl -f http://localhost:8000/health > /dev/null 2>&1; then
            echo "✅ 后端服务正常"
          else
            echo "❌ 后端服务异常"
            exit 1
          fi
          
          if curl -f http://localhost:5173 > /dev/null 2>&1; then
            echo "✅ 前端服务正常"
          else
            echo "❌ 前端服务异常"
            exit 1
          fi
          
          echo "=========================================="
          echo "🎉 部署成功！"
          echo "=========================================="
    
    # 4. 发送通知（成功）
    - name: 📧 发送成功通知
      if: success()
      run: |
        echo "✅ 部署成功！"
        echo "时间: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "提交: ${{ github.sha }}"
        echo "提交者: ${{ github.actor }}"
    
    # 5. 发送通知（失败）
    - name: 📧 发送失败通知
      if: failure()
      run: |
        echo "❌ 部署失败！"
        echo "请检查日志并手动回滚"
